<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>费用 & 保修管理时间轴</title>
<style>
  :root{--bg:#fff;--muted:#6b7280;--line:#e5e7eb;--pri:#2563eb;--card:#f9fafb}
  *{box-sizing:border-box} body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(180%) blur(8px);background:rgba(255,255,255,.9);border-bottom:1px solid var(--line)}
  .bar{display:flex;gap:8px;align-items:center;padding:10px;flex-wrap:wrap}
  input,select,button{font:inherit} input,select{border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff}
  .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.pri{background:#1f6fff;color:#fff;border-color:#1f6fff}
  .muted{color:var(--muted)}
  .chip{font-size:12px;color:#111;background:#eef2ff;border:1px solid #dbeafe;padding:2px 8px;border-radius:999px}
  .wrap{padding:10px}
  #gridWrap{position:relative;overflow:auto;height:calc(100vh - 190px);border-top:1px solid var(--line)}
  #gridHead{display:grid;position:sticky;top:0;background:var(--bg);z-index:3;border-bottom:1px solid var(--line)}
  #grid{display:grid}
  .cell{border-right:1px solid var(--line);padding:8px;text-align:center}
  .row{display:grid;align-items:center;border-bottom:1px solid var(--line);min-height:44px}
  .tag{font-size:12px;color:#155e75;background:#cffafe;border:1px solid #a5f3fc;padding:1px 6px;border-radius:6px}
  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transition:.3s}
  .toast.show{opacity:1}
  dialog{border:0;border-radius:12px;padding:0;max-width:560px;width:calc(100vw - 24px)}
  .dlg{padding:14px 16px}
  .row2{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center;margin:8px 0}
  .subtle{font-size:12px;color:var(--muted)}
  .hstack{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .ghost{background:var(--card);border:1px solid var(--line);border-radius:8px;padding:6px 10px;cursor:pointer}
  .pill{display:inline-flex;gap:6px;align-items:center;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:4px 8px}
  @media (min-width:900px){ .row{min-height:56px} }
</style>
</head>
<body>

<header>
  <div class="bar">
    <b>费用 & 保修管理时间轴</b>
    <span class="muted">（单文件 / 无后端模式 + 可登录云端）</span>
    <span class="chip" id="who">本地模式</span>
    <span style="flex:1"></span>
    <button class="btn" id="btnLogin">登录/注册</button>
    <button class="btn" id="btnLogout" style="display:none">退出</button>
  </div>
  <div class="bar">
    <input id="filter" placeholder="搜索项目/类型/编号…" style="min-width:220px" />
    <label>显示月数 <input id="months" type="number" value="72" style="width:90px"></label>
    <button class="btn" id="btnToday">跳到今天</button>
    <span style="flex:1"></span>
    <button class="btn pri" id="btnAdd">添加项目</button>
  </div>
</header>

<div class="wrap">
  <div id="listTips" class="subtle">提示：横向滚动查看未来月份；鼠标放在金额块可查看具体信息。</div>
</div>

<div id="gridWrap">
  <div id="gridHead"></div>
  <div id="grid"></div>
  <div id="todayLine" style="position:absolute;top:0;bottom:0;width:2px;background:#2563eb;opacity:.6;display:none"></div>
</div>

<!-- 登录/注册 -->
<dialog id="auth">
  <form method="dialog" class="dlg" id="authForm">
    <h3>登录 / 注册</h3>
    <div class="row2"><label>邮箱</label><input id="em" type="email" placeholder="you@example.com" required></div>
    <div class="row2"><label>密码</label><input id="pw" type="password" placeholder="至少 8 位" minlength="8" required></div>
    <div class="hstack" style="justify-content:flex-end;margin-top:8px">
      <button class="btn" value="close">取消</button>
      <button type="button" class="btn" id="goReg">注册</button>
      <button type="button" class="btn pri" id="goLogin">登录</button>
    </div>
    <div id="msg" class="subtle" style="margin-top:8px"></div>
  </form>
</dialog>

<!-- 添加/编辑项目 -->
<dialog id="editor">
  <form method="dialog" class="dlg" id="editForm">
    <h3 id="edTitle">添加项目</h3>
    <div class="row2"><label>类型</label>
      <select id="f_type">
        <option value="plan">套餐/收费</option>
        <option value="warranty">保修期</option>
      </select>
    </div>
    <div class="row2"><label>项目名</label><input id="f_name" placeholder="手机套餐 A / 冰箱" required></div>
    <div class="row2"><label>编号</label><input id="f_number" placeholder="如手机号 / 序列号"></div>
    <div class="row2"><label>开始日期</label><input id="f_start" type="date" required></div>
    <div class="row2"><label>备注</label><input id="f_notes" placeholder="可不填"></div>

    <div id="secPlan">
      <div class="row2"><label>扣费日</label><input id="f_bill" type="number" min="1" max="31" value="1" style="width:120px"></div>
      <div class="row2"><label>金额段</label><div id="phaseList"></div></div>
      <div class="hstack" style="margin-left:120px"><button type="button" class="ghost" id="btnAddPhase">加金额段</button></div>
      <div class="row2"><label>退回期</label><div id="cancelList"></div></div>
      <div class="hstack" style="margin-left:120px"><button type="button" class="ghost" id="btnAddCancel">加退回期</button></div>
    </div>

    <div id="secWarranty" style="display:none">
      <div class="row2"><label>保修月数</label><input id="f_wm" type="number" min="1" value="24" style="width:120px"></div>
    </div>

    <div class="hstack" style="justify-content:flex-end;margin-top:12px">
      <button class="btn" value="close">取消</button>
      <button type="button" class="btn pri" id="btnSave">保存</button>
    </div>
  </form>
</dialog>

<div id="toast" class="toast">已保存</div>

<script>
/* ---------- 工具 ---------- */
const $  = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function pad2(n){return String(n).padStart(2,'0')}
function startOfMonth(d){return new Date(d.getFullYear(),d.getMonth(),1)}
function addMonths(d,n){const x=new Date(d);x.setMonth(x.getMonth()+n);return x}
function toast(t){const el=$('#toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1200)}

/* ---------- 配置：本地 / 线上 API ---------- */
// API_BASE 为空=同域（推荐，部署到 Vercel 时直接用）。如果在本地 HTML 调用线上 API，填你的域名：
// const API_BASE = "https://你的域名.vercel.app"; 
const API_BASE = '';

async function api(url, opts){
  const r = await fetch((API_BASE||'') + url, opts);
  const t = await r.text();
  if(!r.ok) throw new Error(t || r.statusText);
  try{return JSON.parse(t)}catch{return t}
}

/* ---------- 本地存储 ---------- */
let items = [];
function saveLocal(){ localStorage.setItem('items', JSON.stringify(items)); }
function loadLocal(){ try{ items = JSON.parse(localStorage.getItem('items')||'[]'); } catch{ items=[]; } }
loadLocal();

/* ---------- 登录状态 ---------- */
let ONLINE = false;
async function checkLogin(){
  try{
    const me = await api('/api/me'); // 返回 {uid}（已登录）
    ONLINE = true;
    $('#who').textContent = me.uid || '已登录';
    $('#btnLogin').style.display='none';
    $('#btnLogout').style.display='inline-block';
    await cloudLoadItems();
  }catch{
    ONLINE = false;
    $('#who').textContent = '本地模式';
    $('#btnLogin').style.display='inline-block';
    $('#btnLogout').style.display='none';
    render();
  }
}

/* ---- 云端加载（Hash 版 /api/items）并与本地合并（云端优先） ---- */
async function cloudLoadItems(){
  if(!ONLINE) return;
  const cloud = await api('/api/items');
  const map = new Map(cloud.map(x=>[x.id,x]));
  const localOnly = [];
  for(const it of items){ if(!map.has(it.id)){ map.set(it.id,it); localOnly.push(it); } }
  items = [...map.values()];
  for(const it of localOnly){ saveItemToBackend(it).catch(console.warn); }
  saveLocal();
  render();
}

async function saveItemToBackend(it){
  if(!ONLINE) return;
  await api('/api/items', {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(it)});
}

/* ---------- 登录 / 退出 ---------- */
$('#btnLogin').onclick = ()=> $('#auth').showModal();
$('#btnLogout').onclick = async ()=>{ try{ await api('/api/logout',{method:'POST'}); }catch{} checkLogin(); };

$('#goLogin').onclick = async ()=>{
  const btn=$('#goLogin'), reg=$('#goReg'); btn.disabled=reg.disabled=true; $('#msg').textContent='';
  try{
    await api('/api/login',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({email:$('#em').value.trim(),password:$('#pw').value})});
    $('#auth').close(); await checkLogin();
  }catch(e){ $('#msg').textContent=e.message; } finally{ btn.disabled=reg.disabled=false; }
};
$('#goReg').onclick = async ()=>{
  const btn=$('#goReg'), log=$('#goLogin'); btn.disabled=log.disabled=true; $('#msg').textContent='';
  try{
    await api('/api/register',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({email:$('#em').value.trim(),password:$('#pw').value})});
    $('#msg').textContent='注册成功，现在点击登录';
  }catch(e){ $('#msg').textContent=e.message; } finally{ btn.disabled=log.disabled=false; }
};

/* ---------- 添加/编辑 ---------- */
let editingId = null;
function syncTypeUI(){
  const t=$('#f_type').value;
  $('#secPlan').style.display=(t==='plan')?'':'none';
  $('#secWarranty').style.display=(t==='warranty')?'':'none';
}
$('#f_type').onchange = syncTypeUI;

$('#btnAdd').onclick = ()=>{
  editingId=null; $('#edTitle').textContent='添加项目';
  $('#f_type').value='plan'; $('#f_name').value=''; $('#f_number').value='';
  $('#f_start').value=new Date().toISOString().slice(0,10);
  $('#f_notes').value=''; $('#f_bill').value=1; $('#f_wm').value=24;
  $('#phaseList').innerHTML=''; addPhase({fromMonth:1,amount:0});
  $('#cancelList').innerHTML='';
  syncTypeUI(); $('#editor').showModal();
};

function addPhase(init){ const div=document.createElement('div'); div.className='pill';
  div.innerHTML=`<span>第</span><input class="m" type="number" min="1" value="${init?.fromMonth||1}" style="width:70px">
  <span>个月起</span><input class="a" type="number" value="${init?.amount||0}" style="width:100px"><span>元/月</span>
  <button type="button" class="ghost del">删除</button>`;
  div.querySelector('.del').onclick=()=>div.remove(); $('#phaseList').appendChild(div);
}
function addCancel(init){ const div=document.createElement('div'); div.className='pill';
  div.innerHTML=`<span>第</span><input class="fm" type="number" min="1" value="${init?.fromMonth||1}" style="width:70px">
  <span>-</span><input class="tm" type="number" min="1" value="${init?.toMonth||1}" style="width:70px">
  <span>个月</span><button type="button" class="ghost del">删除</button>`;
  div.querySelector('.del').onclick=()=>div.remove(); $('#cancelList').appendChild(div);
}
$('#btnAddPhase').onclick=()=>addPhase();
$('#btnAddCancel').onclick=()=>addCancel();

function readForm(){
  const type=$('#f_type').value.trim(); const name=$('#f_name').value.trim(); const start=$('#f_start').value;
  if(!name) return alert('请填写项目名称'); if(!start) return alert('请选择开始日期');
  const base={ type, name, number:$('#f_number').value.trim(), startDate:start, notes:$('#f_notes').value.trim() };
  if(type==='warranty') return { id: editingId||`it_${Date.now()}`, ...base, warrantyMonths:Number($('#f_wm').value)||0, createdAt:Date.now() };
  const phases=[...$$('#phaseList .pill')].map(row=>({fromMonth:Number(row.querySelector('.m').value)||1, amount:Number(row.querySelector('.a').value)||0})).sort((a,b)=>a.fromMonth-b.fromMonth);
  const cancels=[...$$('#cancelList .pill')].map(row=>({fromMonth:Number(row.querySelector('.fm').value)||1, toMonth:Number(row.querySelector('.tm').value)||1}));
  return { id: editingId||`it_${Date.now()}`, ...base, billingDay:Number($('#f_bill').value)||1, pricePhases:phases, cancelWindows:cancels, createdAt:Date.now() };
}
$('#btnSave').onclick = async ()=>{
  const it=readForm(); if(!it) return;
  const idx=items.findIndex(x=>x.id===it.id); if(idx>=0) items[idx]=it; else items.push(it);
  saveLocal(); $('#editor').close(); if(ONLINE) try{await saveItemToBackend(it);}catch(e){console.warn(e)}
  toast('已保存'); render();
};

/* ---------- 时间轴 ---------- */
const head=$('#gridHead'); const grid=$('#grid'); const wrap=$('#gridWrap'); const todayLine=$('#todayLine');
const COL_W=110;
function resolvePlanPrice(phases, idx){ if(!phases?.length) return null; let a=null; phases.sort((x,y)=>x.fromMonth-y.fromMonth).forEach(p=>{ if(idx>=p.fromMonth) a=p.amount }); return a }
function isInCancel(wins, idx){ return wins?.some?.(w=> idx>=w.fromMonth && idx<=w.toMonth) }

function render(){
  const filter=($('#filter').value||'').trim().toLowerCase();
  const data=filter?items.filter(it=>(it.name+' '+it.type+' '+(it.number||'')).toLowerCase().includes(filter)):items.slice();
  const months=Math.max(1,Number($('#months').value)||72);
  const today=new Date();
  const minStart=data.length?data.map(it=>startOfMonth(new Date(it.startDate))).reduce((a,b)=>a<b?a:b):startOfMonth(today);
  const mlist=Array.from({length:months},(_,i)=>addMonths(minStart,i));

  head.style.gridTemplateColumns=`repeat(${mlist.length}, ${COL_W}px)`;
  head.innerHTML=mlist.map(m=>{const q=Math.ceil((m.getMonth()+1)/3);return `<div class="cell"><div><b>${m.getFullYear()}-${pad2(m.getMonth()+1)}</b></div><div class="subtle">Q${q}</div></div>`}).join('');

  grid.style.gridTemplateColumns=`repeat(${mlist.length}, ${COL_W}px)`; grid.innerHTML='';

  for(const it of data){
    const row=document.createElement('div'); row.className='row'; row.style.gridTemplateColumns=`repeat(${mlist.length}, ${COL_W}px)`;

    const info=document.createElement('div'); info.style.position='sticky'; info.style.left='0'; info.style.gridColumn='1 / span 2';
    info.style.background='linear-gradient(90deg,#fff 70%,transparent)'; info.style.padding='6px 8px'; info.style.zIndex='2';
    info.innerHTML=`<div class="hstack" style="gap:6px"><b>${it.name}</b><span class="tag">${it.type==='warranty'?'保修':'套餐'}</span>${it.number?`<span class="subtle">#${it.number}</span>`:''}<span class="subtle">开始：${it.startDate}</span><button class="ghost" data-id="${it.id}">编辑</button></div>`;
    info.querySelector('button').onclick=()=>openEdit(it);
    row.appendChild(info);

    for(let i=0;i=0){
    todayLine.style.display='block'; todayLine.style.left=`${iToday*COL_W+COL_W/2}px`;
  }else todayLine.style.display='none';
}

function openEdit(it){
  editingId=it.id; $('#edTitle').textContent='编辑项目';
  $('#f_type').value=it.type||'plan'; $('#f_name').value=it.name||''; $('#f_number').value=it.number||'';
  $('#f_start').value=it.startDate||new Date().toISOString().slice(0,10); $('#f_notes').value=it.notes||'';
  $('#f_bill').value=it.billingDay||1; $('#f_wm').value=it.warrantyMonths||24;
  $('#phaseList').innerHTML=''; (it.pricePhases||[]).forEach(p=>addPhase(p));
  $('#cancelList').innerHTML=''; (it.cancelWindows||[]).forEach(c=>addCancel(c));
  syncTypeUI(); $('#editor').showModal();
}

$('#filter').oninput=render; $('#months').oninput=render;
$('#btnToday').onclick=()=>{ wrap.scrollLeft=0; /* 可扩展为定位今天 */ };

checkLogin(); render();
</script>
</body>
</html>
