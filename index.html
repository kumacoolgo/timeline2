<!doctype html>
$('#phaseList').innerHTML=''; addPhase({fromMonth:1,amount:0});
$('#cancelList').innerHTML='';
syncTypeUI();
}
let editingId = null;
function readForm(){
const type=$('#f_type').value.trim(); const name=$('#f_name').value.trim(); const start=$('#f_start').value;
if(!name) return alert('请填写项目名称'); if(!start) return alert('请选择开始日期');
const base={ type, name, number:$('#f_number').value.trim(), startDate:start, notes:$('#f_notes').value.trim() };
if(type==='warranty') return { id: editingId||`it_${Date.now()}`, ...base, warrantyMonths:Number($('#f_wm').value)||0 };
const phases = [...$$('#phaseList .phase')].map(row=>({fromMonth:Number(row.querySelector('.m').value)||1, amount:Number(row.querySelector('.a').value)||0})).sort((a,b)=>a.fromMonth-b.fromMonth);
const cancels = [...$$('#cancelList .cancel')].map(row=>({fromMonth:Number(row.querySelector('.fm').value)||1, toMonth:Number(row.querySelector('.tm').value)||1}));
return { id: editingId||`it_${Date.now()}`, ...base, billingDay:Number($('#f_bill').value)||1, pricePhases:phases, cancelWindows:cancels };
}
$('#btnAddPhase').onclick = ()=> addPhase();
$('#btnAddCancel').onclick = ()=> addCancel();
function addPhase(init){ const div=document.createElement('div'); div.className='phase'; div.innerHTML=`
<div style="display:flex;gap:8px;align-items:center;margin-top:4px">
<span class="small">第</span>
<input class="m" type="number" min="1" value="${init?.fromMonth||1}" style="width:80px" />
<span class="small">个月起</span>
<input class="a" type="number" value="${init?.amount||0}" style="width:120px" />
<span class="small">日元/月</span>
<button class="ghost del">删除</button>
</div>`; div.querySelector('.del').onclick=()=>div.remove(); $('#phaseList').appendChild(div);
}
function addCancel(init){ const div=document.createElement('div'); div.className='cancel'; div.innerHTML=`
<div style="display:flex;gap:8px;align-items:center;margin-top:4px">
<span class="small">第</span>
<input class="fm" type="number" min="1" value="${init?.fromMonth||1}" style="width:80px" />
<span class="small">-</span>
<input class="tm" type="number" min="1" value="${init?.toMonth||1}" style="width:80px" />
<span class="small">个月</span>
<button class="ghost del">删除</button>
</div>`; div.querySelector('.del').onclick=()=>div.remove(); $('#cancelList').appendChild(div);
}
$('#btnSave').onclick = async ()=>{
const it=readForm(); if(!it) return;
const idx = items.findIndex(x=>x.id===it.id);
if(idx>=0) items[idx]=it; else items.push(it);
save(); formWrap.style.display='none';
await saveItemToBackend(it); // 登录时同步云端
render();
}


// ======= 时间轴渲染 =======
const head = $('#gridHead'); const grid = $('#grid'); const wrap = $('#gridWrap'); const todayLine = $('#todayLine'); const leftRows = $('#leftRows');
const COL_W = 110; const today = new Date();


function resolvePlanPrice(phases, idx){ if(!phases?.length) return null; let a=null; phases.sort((x,y)=>x.fromMonth-y.fromMonth).forEach(p=>{ if(idx>=p.fromMonth) a=p.amount }); return a }
function isInCancel(wins, idx){ return wins?.some?.(w=> idx>=w.fromMonth && idx<=w.toMonth) }


function render(){
const filter = ($('#filter').value||'').trim().toLowerCase();
const data = filter? items.filter(it=> (it.name + ' ' + it.type + ' ' + (it.number||'')).toLowerCase().includes(filter)) : items.slice();
const months = Number($('#months').value)||72;
const minStart = data.length? data.map(it=>startOfMonth(new Date(it.startDate))).reduce((a,b)=>a<b?a:b) : startOfMonth(today);
const mlist = []; for(let i=0;i<months;i++) mlist.push(addMonths(minStart,i));


head.style.gridTemplateColumns = `repeat(${mlist.length}, ${COL_W}px)`;
head.innerHTML = mlist.map(m=>{ const q=Math.ceil((m.getMonth()+1)/3); return `<div class="cell nowrap" style="height:54px;text-align:center"><div><b>${m.getFullYear()}-${pad2(m.getMonth()+1)}</b></div><div class="small">Q${q}</div></div>` }).join('');


grid.style.gridTemplateColumns = `repeat(${mlist.length}, ${COL_W}px)`;
</html>