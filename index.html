<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>费用时间轴</title>
<style>
:root{--brand:#3b82f6;--muted:#667085;--card:#ffffff;--line:#eef0f3;--pill:#f1f5ff;--row-h:56px;--col-w:110px;--radius:14px}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#f6f8fb;color:#0f172a;font:14px/1.6 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
button{border:0;border-radius:10px;background:#111827;color:#fff;padding:8px 12px;cursor:pointer}
button.ghost{background:#eceff3;color:#111827} button.primary{background:var(--brand)}
input,select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff;outline:none}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.wrap{max-width:1200px;margin:18px auto;padding:0 12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:10px}
.header{display:flex;align-items:center;gap:10px;justify-content:space-between}
.header .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--pill);border:1px solid var(--line)}
#layout{display:grid;grid-template-columns: 340px 1fr; gap:14px; align-items:start}
/* 【修改】为拖拽添加样式 */
#leftWrap{max-height: calc(var(--row-h) * 10 + 8px);overflow-y:auto;padding-right:6px}
.item{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-radius:12px;border:1px solid var(--line);background:#fff;height:var(--row-h);gap:8px;margin-bottom:8px;cursor:grab}
.item:active { cursor: grabbing; }
.item.active{outline:2px solid var(--brand)} .item .title{font-weight:600} .item .meta{font-size:12px;color:var(--muted)}
#gridHead{display:grid;gap:8px;margin-bottom:8px} #grid{display:grid;gap:8px}
.cell{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px}
.nowrap{white-space:nowrap}
.badge{display:inline-block;padding:6px 10px;border-radius:10px;background:#eef5ff;color:#0f172a;border:1px solid #dbe8ff}
.badge.cancel{background:#fff6f1;border-color:#ffd8bf}
#dlg{position:fixed; inset:0; display:none; align-items:center; justify-content:center;background:rgba(0,0,0,.35); z-index:9999}
#panel{width:min(680px,92vw); max-height:92vh; overflow:auto;background:#fff;border-radius:14px;padding:14px; box-shadow:0 12px 32px rgba(0,0,0,.18)}
fieldset{border:1px dashed var(--line);border-radius:10px;padding:8px;margin-top:6px}
fieldset legend{font-size:12px;color:var(--muted)} .row-fields{display:flex;gap:8px;align-items:center;margin:6px 0}
.row-fields input{width:120px} .row-fields .m{width:80px} .row-fields .a{width:120px}
@media (max-width: 860px){
  #layout{grid-template-columns: 1fr}
  .row-fields{flex-wrap:wrap}
  #leftWrap { max-height: 25vh; } /* 移动端列表高度 */
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header card">
    <div class="left">
      <b>费用时间轴</b>
      <span id="modePill" class="pill small">检查登录...</span>
      <input id="filter" placeholder="搜索项目/类型/编号..." style="width:240px"/>
      <div class="row">
        <label class="small">显示月数</label>
        <select id="months"><option>12</option><option selected>24</option><option>36</option><option>60</option><option>72</option></select>
        <button id="btnToday" class="ghost">跳到今天</button>
      </div>
    </div>
    <div class="row">
      <button id="btnUser" class="ghost">登录/注册</button>
      <button id="btnLogout" class="ghost" style="display:none">登出</button>
      <button id="btnAdd"  class="primary">添加项目</button>
    </div>
  </div>

  <div id="layout">
    <div class="card">
      <div id="leftWrap"></div>
    </div>

    <div class="card" style="overflow-x: auto;">
      <div id="gridHead"></div>
      <div id="grid"></div>
    </div>
  </div>
</div>

<div id="dlg">
  <div id="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="dlgTitle">编辑项目</h3><button id="btnClose" class="ghost">×</button>
    </div>
    <div class="row" style="gap:10px">
      <select id="f_type"><option value="plan">套餐</option><option value="warranty">保修</option><option value="insurance">保险</option></select>
      <input id="f_name" placeholder="项目名称"/><input id="f_number" placeholder="编号/卡号(可选)" style="width:160px"/><input id="f_start" type="date"/>
    </div>
    <div id="blockPlan">
      <div class="row" style="margin-top:6px"><label class="small">出账日</label><input id="f_bill" type="number" min="1" max="28" value="1" style="width:80px"/></div>
      <fieldset><legend>金额段（从第 X 个月起，￥金额 / 月）</legend><div id="phaseList"></div><div style="margin-top:6px"><button id="btnAddPhase" class="ghost" type="button">加金额段</button></div></fieldset>
      <fieldset><legend>退会期（从第 X ～ 第 Y 个月为退会期）</legend><div id="cancelList"></div><div style="margin-top:6px"><button id="btnAddCancel" class="ghost" type="button">加退会期</button></div></fieldset>
    </div>
    <div id="blockWarranty" style="display:none;margin-top:8px"><label class="small">保修期（月）</label><input id="f_wm" type="number" min="0" value="24" style="width:120px"/></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="btnCancel" class="ghost" type="button">取消</button><button id="btnSave" class="primary" type="button">保存</button></div>
  </div>
</div>

<div id="dlgAuth" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);align-items:center;justify-content:center;z-index:9999">
  <div class="card" style="width:min(520px,92vw);padding:14px">
    <h3>登录 / 注册</h3>
    <div style="display:flex;flex-direction:column;gap:10px">
      <input id="em" placeholder="邮箱"/><input id="pw" type="password" placeholder="密码（≥8位）"/>
      <div id="msg" class="small" style="color:#ef4444"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end"><button id="btnAuthCancel" class="ghost" type="button">取消</button><button id="goReg" class="ghost" type="button">注册</button><button id="goLogin" class="primary" type="button">登录</button></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const COL_W=110; let items=[], activeId=null, editingId=null, ONLINE=false;
let sortableList = null; // 用于 SortableJS 实例
function pad2(n){return (n<10?'0':'')+n;} function startOfMonth(d){return new Date(d.getFullYear(), d.getMonth(), 1)} function addMonths(d,n){ return new Date(d.getFullYear(), d.getMonth()+n, 1) }

// 【移除】save() 和 load() 函数 (localStorage)

function syncTypeUI(){ const t=$('#f_type').value; $('#blockPlan').style.display=(t==='plan'||t==='insurance')?'block':'none'; $('#blockWarranty').style.display=(t==='warranty')?'block':'none'; }
function addPhase(i){const d=document.createElement('div');d.className='row-fields';d.innerHTML=`<span class=small>第</span><input class=m type=number min=1 value="${i?.fromMonth||1}"><span class=small>个月起</span><input class=a type=number value="${i?.amount||0}"><span class=small>日元/月</span><button class="ghost del" type=button>删除</button>`;d.querySelector('.del').onclick=()=>d.remove();$('#phaseList').appendChild(d)}
function addCancel(i){const d=document.createElement('div');d.className='row-fields';d.innerHTML=`<span class=small>第</span><input class=fm type=number min=1 value="${i?.fromMonth||1}"><span class=small>-</span><input class=tm type=number min=1 value="${i?.toMonth||1}"><span class=small>个月</span><button class="ghost del" type=button>删除</button>`;d.querySelector('.del').onclick=()=>d.remove();$('#cancelList').appendChild(d)}
$('#btnAddPhase').onclick=()=>addPhase(); $('#btnAddCancel').onclick=()=>addCancel();
function readForm(){ const type=$('#f_type').value.trim(), name=$('#f_name').value.trim(), start=$('#f_start').value; if(!name){alert('请填写项目名称');return null} if(!start){alert('请选择开始日期');return null} const base={type,name,number:$('#f_number').value.trim(),startDate:start}; if(type==='warranty'){return {id:editingId||undefined,...base,warrantyMonths:Number($('#f_wm').value)||0}} const phases=[...$$('#phaseList .row-fields')].map(r=>({fromMonth:Number(r.querySelector('.m').value)||1,amount:Number(r.querySelector('input.a').value)||0})).sort((a,b)=>a.fromMonth-b.fromMonth); const cancels=[...$$('#cancelList .row-fields')].map(r=>({fromMonth:Number(r.querySelector('.fm').value)||1,toMonth:Number(r.querySelector('.tm').value)||1})); return {id:editingId||undefined,...base,billingDay:Number($('#f_bill').value)||1,pricePhases:phases,cancelWindows:cancels}; }
function fillForm(it){ $('#f_type').value=it?.type||'plan'; $('#f_name').value=it?.name||''; $('#f_number').value=it?.number||''; $('#f_start').value=it?.startDate||''; $('#f_bill').value=it?.billingDay||1; $('#f_wm').value=it?.warrantyMonths||24; $('#phaseList').innerHTML=''; $('#cancelList').innerHTML=''; (it?.pricePhases?.length?it.pricePhases:[{fromMonth:1,amount:0}]).forEach(addPhase); (it?.cancelWindows||[]).forEach(addCancel); syncTypeUI(); }
function resolvePlanPrice(ph,idx){ if(!ph?.length) return null; let a=null; ph.sort((x,y)=>x.fromMonth-y.fromMonth).forEach(p=>{ if(idx>=p.fromMonth) a=p.amount }); return a } function isInCancel(w,idx){ return w?.some?.(x=> idx>=x.fromMonth && idx<=x.toMonth) }
function visibleItems(){ return activeId? items.filter(i=>i.id===activeId) : (items.length?[items[0]]:[]) }
function render(){ 
  const L=$('#leftWrap');
  // 【修改】如果存在 Sortable 实例，先销毁
  if(sortableList) {
    sortableList.destroy();
    sortableList = null;
  }
  
  L.innerHTML = items.map(it=>`<div class="item ${it.id===activeId?'active':''}" data-id="${it.id}"><div><div class=title>${it.name} ${it.type==='plan'?'<span class=small style=color:#6b5cff>套餐</span>':it.type==='insurance'?'<span class=small style=color:#10b981>保险</span>':'<span class=small style=color:#3b82f6>保修</span>'}</div><div class=meta>#${it.number||'-'}　开始: ${it.startDate||'-'}</div></div><div class=ops><button class="ghost btnEdit" data-id="${it.id}" type=button>编辑</button><button class="ghost btnDel" data-id="${it.id}" type=button>删除</button></div></div>`).join(''); 
  
  L.querySelectorAll('.item').forEach(div=>{ const id=div.dataset.id; div.onclick=e=>{ if(e.target.closest('button')) return; activeId=id; render(); }; }); 
  
  L.querySelectorAll('.btnEdit').forEach(b=> b.onclick=e=>{e.stopPropagation(); const it=items.find(x=>x.id===b.dataset.id); editingId=it.id; fillForm(it); $('#dlgTitle').textContent='编辑项目'; $('#dlg').style.display='flex';}); 
  
  // 【修改】删除按钮改为 async，并调用 API
  L.querySelectorAll('.btnDel').forEach(b=> b.onclick= async e=>{ // ⬅️ async
    e.stopPropagation(); 
    if(!confirm('确定删除该项目？'))return; 
    const id=b.dataset.id;
    try {
      await api('/api/items?id=' + id, { method: 'DELETE' }); // ⬅️ API 调用
      items=items.filter(x=>x.id!==id); 
      if(activeId===id) activeId=items[0]?.id||null; 
      render(); // ⬅️ 移除 save()
    } catch (err) {
      alert('删除失败: ' + err.message);
    }
  }); 
  
  const data=visibleItems(); const head=$('#gridHead'),grid=$('#grid'); if(!data.length){ head.innerHTML=''; grid.innerHTML='<div class=small>还没有项目，点击右上角“添加项目”。</div>'; return } const months=Number($('#months').value)||24; const minStart=startOfMonth(new Date(data[0].startDate||new Date())); const mlist=[]; for(let i=0;i<months;i++) mlist.push(addMonths(minStart,i)); head.style.gridTemplateColumns=`repeat(${mlist.length}, ${COL_W}px)`; head.innerHTML=mlist.map(m=>{const q=Math.ceil((m.getMonth()+1)/3); return `<div class="cell nowrap" style="text-align:center"><div><b>${m.getFullYear()}-${pad2(m.getMonth()+1)}</b></div><div class=small>Q${q}</div></div>`}).join(''); grid.style.gridTemplateColumns=`repeat(${mlist.length}, ${COL_W}px)`; const it=data[0]; const m0=startOfMonth(new Date(it.startDate)); const MonthIndex=d=>(d.getFullYear()-m0.getFullYear())*12 + d.getMonth()-m0.getMonth() + 1; const cells=[]; for(let i=0;i<mlist.length;i++){ const idx=MonthIndex(mlist[i]); if(it.type==='warranty'){ const inWar = idx>=1 && idx<= (Number(it.warrantyMonths||0)); cells.push(`<div class=cell style="text-align:center">${inWar?'<span class=badge>保修中</span>':''}</div>`); }else{ const amount=resolvePlanPrice(it.pricePhases,idx); const cancel=isInCancel(it.cancelWindows,idx); cells.push(`<div class=cell style="text-align:center">${cancel?'<div class="badge cancel">退会期</div>':''}${amount!=null?`<div class=badge>￥ ${amount.toLocaleString()}</div>`:''}</div>`); } } grid.innerHTML=cells.join(''); 

  // 【新增】初始化 SortableJS
  sortableList = new Sortable(L, {
    animation: 150,
    handle: '.item', // 拖拽手柄
    onEnd: async (evt) => { // 拖拽结束事件
      // 1. 更新本地数组顺序
      const [movedItem] = items.splice(evt.oldIndex, 1);
      items.splice(evt.newIndex, 0, movedItem);

      // 2. 准备批量 API 更新
      const updates = [];
      items.forEach((it, idx) => {
        const newOrder = idx + 1; // 使用 1-based 索引作为排序值
        if (it.order !== newOrder) { // 仅当 order 变化时才更新
          it.order = newOrder; // 更新本地对象
          // 准备 API 调用，只发送 order 字段
          updates.push(api(`/api/items?id=${it.id}`, {
            method: 'PUT',
            headers: {'content-type': 'application/json'},
            body: JSON.stringify({ order: newOrder }) 
          }));
        }
      });

      // 3. 并发执行所有更新
      if(updates.length > 0) {
        try {
          await Promise.all(updates);
        } catch (e) {
          alert('保存排序失败: ' + e.message);
          // 失败时从云端重新加载，防止不一致
          await loadCloudItems();
        }
      }
      // 4. 重新渲染以确保 activeId 等状态正确 (可选，但推荐)
      render();
    }
  });
}
$('#f_type').onchange=syncTypeUI; $('#btnAdd').onclick=()=>{ editingId=null; fillForm(null); $('#dlgTitle').textContent='新增项目'; $('#dlg').style.display='flex'; }; $('#btnClose').onclick=()=>$('#dlg').style.display='none'; $('#btnCancel').onclick=()=>$('#dlg').style.display='none'; $('#dlg').addEventListener('click',e=>{ if(e.target.id==='dlg') $('#dlg').style.display='none'; });

// 【修改】保存按钮改为 async，并调用 API (POST / PUT)
$('#btnSave').onclick= async ()=>{ // ⬅️ async
  const it = readForm(); 
  if(!it) return;
  
  $('#btnSave').disabled = true;
  try {
    if (editingId) {
      // 编辑 (PUT)
      const updatedItem = { ...it, id: editingId }; // 确保 it 对象有 id
      await api('/api/items?id=' + editingId, {
        method: 'PUT',
        headers: {'content-type': 'application/json'},
        body: JSON.stringify(updatedItem)
      });
      // 更新本地数组
      const idx = items.findIndex(x => x.id === editingId);
      if (idx >= 0) items[idx] = updatedItem;
    } else {
      // 新增 (POST)
      const newItem = await api('/api/items', {
        method: 'POST',
        headers: {'content-type': 'application/json'},
        body: JSON.stringify(it)
      });
      items.push(newItem); // ⬅️ 使用 API 返回的带 ID 和 order 的对象
      if (!activeId) activeId = newItem.id;
    }
    $('#dlg').style.display='none';
    render(); // ⬅️ 移除 save()
  } catch (e) {
    alert('保存失败: ' + e.message);
  } finally {
    $('#btnSave').disabled = false;
  }
};
$('#btnToday').onclick=()=>alert('已定位到时间轴起点（从第一个项目的开始月）。');

async function api(path, init){
  const r = await fetch(path, { credentials:'include', ...init });
  const text = await r.text();
  let data; try{ data = JSON.parse(text||'{}') }catch{ data = { error:text||'网络错误' } }
  if(!r.ok){
    // 【修改】如果未授权，触发登录
    if (r.status === 401 && path !== '/api/login' && path !== '/api/register') {
      ONLINE = false;
      $('#modePill').textContent = '未登录';
      $('#btnUser').textContent = '登录/注册';
      $('#btnLogout').style.display = 'none';
      $('#dlgAuth').style.display = 'flex';
    }
    const msg = data.reason ? `${data.error} (${data.reason})` : (data.error || `HTTP ${r.status}`);
    throw new Error(msg);
  }
  return data;
}

// 【修改】登录按钮重命名为 btnUser
$('#btnUser').onclick=()=>{ $('#em').value=''; $('#pw').value=''; $('#msg').textContent=''; $('#dlgAuth').style.display='flex'; }; 
$('#btnAuthCancel').onclick=()=>$('#dlgAuth').style.display='none';

// 【新增】登出按钮
$('#btnLogout').onclick = async () => {
  if (!confirm('确定要登出吗？')) return;
  try {
    await api('/api/logout', { method: 'POST' });
    location.reload(); // 刷新页面
  } catch (e) {
    alert('登出失败: ' + e.message);
  }
};

$('#goReg').onclick=async()=>{ const b=$('#goReg'); b.disabled=true; try{ await api('/api/register',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({email:$('#em').value.trim(), password:$('#pw').value})}); $('#msg').style.color='#16a34a'; $('#msg').textContent='注册成功，请点击登录'; }catch(e){ $('#msg').style.color='#ef4444'; $('#msg').textContent=e.message||'注册失败'; } finally{ b.disabled=false; } }

// 【修改】登录成功后加载云端数据
$('#goLogin').onclick = async ()=>{
  const b=$('#goLogin'); b.disabled=true;
  try{
    await api('/api/login',{
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ email: $('#em').value.trim(), password: $('#pw').value })
    });
    // 登录成功，获取 'me' 信息并加载数据
    const me = await api('/api/me'); 
    ONLINE=true; 
    $('#modePill').textContent='云端'; 
    $('#btnUser').textContent = me.email; // 显示邮箱
    $('#btnLogout').style.display = 'inline-block'; // 显示登出按钮
    $('#dlgAuth').style.display='none';
    
    await loadCloudItems(); // ⬅️ 加载云端数据

  }catch(e){
    $('#msg').style.color='#ef4444';
    $('#msg').textContent = e.message || '登录失败';
  }finally{ b.disabled=false; }
};

// 【新增】从云端加载项目
async function loadCloudItems() {
  try {
    items = await api('/api/items'); // GET /api/items
    if (items.length > 0 && !items.find(it => it.id === activeId)) {
      activeId = items[0].id;
    }
    render();
  } catch (e) {
    alert('加载数据失败: ' + e.message);
  }
}

// 【新增】检查登录状态
async function checkLogin() {
  try {
    const me = await api('/api/me');
    ONLINE = true;
    $('#modePill').textContent = '云端';
    $('#btnUser').textContent = me.email;
    $('#btnLogout').style.display = 'inline-block';
    await loadCloudItems();
  } catch (e) {
    // 未登录
    ONLINE = false;
    $('#modePill').textContent = '未登录';
    $('#btnUser').textContent = '登录/注册';
    $('#dlgAuth').style.display = 'flex';
  }
}

// 【修改】bootstrap 函数
function bootstrap(){ 
  checkLogin(); // ⬅️ 不再加载本地数据，改为检查登录
}
bootstrap();
</script>

</body></html>