<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>费用 & 保修管理时间轴（单文件 / 无后端 + 可登录云端）</title>
  <style>
    :root{
      --bg:#f7f8fb;
      --card:#fff;
      --fg:#1f2937;
      --muted:#6b7280;
      --brand:#2563eb;
      --chip-bg:#ecf5ff;
      --chip-outline:#c7d7ff;
      --cell-w: 110px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:1200px;margin:22px auto;padding:0 12px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #d6dae3;background:#fff;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#2563eb;color:#fff}
    .btn.ghost{background:#fff;border-color:#e5e7eb;color:var(--fg)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    input,select,textarea{padding:9px 10px;border:1px solid #d6dae3;border-radius:10px;background:#fff;min-width:0}
    .tag{display:inline-block;padding:2px 8px;border-radius:20px;font-size:12px;background:#eef2ff;color:#3b82f6;border:1px solid #c7d7ff}
    .muted{color:#6b7280}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .left{width:280px;flex:0 0 280px}
    .right{min-width:0;overflow:hidden}
    .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .search{flex:1;min-width:220px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #dbe2f1;background:#fff}
    #gridWrap{overflow:auto;border:1px solid #e5e7eb;border-radius:14px;background:#fff}
    #gridHead, #grid{display:grid;grid-auto-rows:minmax(86px,auto)}
    #gridHead .cell{border-bottom:1px solid #eef1f7;border-right:1px solid #eef1f7;padding:8px 6px;background:#fbfcff}
    #grid .cell{border-right:1px solid #f0f3fa;position:relative}
    .nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chip{display:inline-flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;padding:8px 10px;border-radius:10px;border:1px solid var(--chip-outline);background:var(--chip-bg);min-width:72px}
    .chip .sub{font-size:12px;color:#475569}
    .todayLine{position:absolute;top:0;bottom:0;width:2px;background:#2563eb;pointer-events:none}
    .leftList .item{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px dashed #edf0f6}
    .leftList .item.dragging{opacity:.6}
    .leftList .name{font-weight:600}
    .leftList .meta{font-size:12px;color:#64748b}
    .leftList .actions{margin-left:auto;display:flex;gap:8px}
    .small{font-size:12px;color:#64748b}
    .hint{margin:8px 0 0 6px;color:#64748b}
    .hidden{display:none}
    dialog{border:none;border-radius:16px;max-width:680px;width:92vw;padding:0}
    dialog .dlg-body{padding:18px}
    dialog .dlg-foot{padding:14px 18px;border-top:1px solid #eef2f8;display:flex;justify-content:flex-end;gap:10px;background:#fbfcff;border-radius:0 0 16px 16px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .form-row{display:flex;flex-direction:column;gap:6px}
    @media (max-width: 760px){
      .container{padding:0 8px}
      .left{width:100%;flex:1 1 auto}
      .right{width:100%}
      .grid2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="toolbar">
    <div class="row" style="gap:10px">
      <strong>费用 & 保修管理时间轴</strong>
      <span class="muted">(单文件 / 无后端模式 + 可登录云端)</span>
      <span id="modeBadge" class="pill">本地模式</span>
    </div>
    <div class="row">
      <button id="btnLogin" class="btn">登录/注册</button>
      <button id="btnLogout" class="btn hidden">退出</button>
      <button id="btnAdd" class="btn primary">添加项目</button>
    </div>
  </div>

  <div class="row" style="gap:12px;margin-bottom:12px">
    <input id="filter" class="search" placeholder="搜索项目/类型/编号...">
    <label class="pill">显示月数
      <input id="months" type="number" value="72" style="width:72px;margin-left:8px;border:none;outline:none">
    </label>
    <button id="jumpToday" class="btn">跳到今天</button>
  </div>

  <div class="row">
    <div class="left card leftList" id="leftRows" style="align-self:stretch"></div>
    <div class="right" style="flex:1 1 auto">
      <div id="gridWrap" class="card" style="position:relative">
        <div id="todayLine" class="todayLine" style="display:none"></div>
        <div id="gridHead"></div>
        <div id="grid"></div>
      </div>
      <div class="hint small">提示：横向滚动查看未来月份；鼠标放在金额块可查看具体信息。（<b>退会期</b>显示在金额下方）。</div>
    </div>
  </div>
</div>

<dialog id="dlgAuth">
  <form method="dialog" class="dlg-body">
    <h3>登录 / 注册</h3>
    <div class="form-row"><label>邮箱</label><input id="authEmail" type="email" placeholder="you@example.com"></div>
    <div class="form-row"><label>密码</label><input id="authPass" type="password" placeholder="至少 8 位"></div>
    <div id="authMsg" class="small" style="min-height:18px;color:#ef4444"></div>
  </form>
  <div class="dlg-foot">
    <button id="authCancel" class="btn">取消</button>
    <button id="authRegister" class="btn">注册</button>
    <button id="authLogin" class="btn primary">登录</button>
  </div>
</dialog>

<dialog id="dlgEdit">
  <form method="dialog" class="dlg-body">
    <h3 id="dlgTitle">新增项目</h3>
    <div class="grid2">
      <div class="form-row"><label>类型</label>
        <select id="f_type">
          <option value="plan">套餐</option>
          <option value="warranty">保修</option>
          <option value="insurance">保险</option>
        </select>
      </div>
      <div class="form-row"><label>项目名称</label><input id="f_name"></div>
      <div class="form-row"><label>编号</label><input id="f_number"></div>
      <div class="form-row"><label>开始日期</label><input id="f_start" type="date"></div>
      <div class="form-row"><label>备注</label><input id="f_notes"></div>
      <div class="form-row" id="row_billday"><label>计费日</label><input id="f_bill" type="number" min="1" max="31" value="1"></div>
      <div class="form-row" id="row_wm" style="display:none"><label>保修/保险期(月)</label><input id="f_wm" type="number" min="1" value="24"></div>
    </div>
    <div id="planBlock">
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <strong>金额段</strong>
        <div><button type="button" id="btnAddPhase" class="btn">加金额段</button><button type="button" id="btnAddCancel" class="btn">加退会期</button></div>
      </div>
      <div id="phaseList"></div>
      <div id="cancelList"></div>
    </div>
  </form>
  <div class="dlg-foot">
    <button id="btnDelete" class="btn danger" style="margin-right:auto;display:none;border-color:#fecaca;color:#b91c1c;background:#fff">删除</button>
    <button id="btnClose" class="btn">取消</button>
    <button id="btnSave" class="btn primary">保存</button>
  </div>
</dialog>

<script>
const $ = (s, el=document)=>el.querySelector(s);
const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));
let items = []; let ONLINE=false; let editingId=null;

function load(){ try{return JSON.parse(localStorage.getItem('timeline_items')||'[]')}catch(e){return []} }
function save(){ localStorage.setItem('timeline_items', JSON.stringify(items)); }
async function api(path,opt={}){
  const r = await fetch(path,{headers:{'content-type':'application/json'},credentials:'include',...opt});
  const data = await r.json().catch(()=>({}));
  if(!r.ok) throw new Error(data?.error||('请求失败 '+r.status));
  return data;
}

async function checkLogin(){
  try{ const me = await api('/api/me'); ONLINE=true;
    $('#modeBadge').textContent='云端'; $('#btnLogin').classList.add('hidden'); $('#btnLogout').classList.remove('hidden'); await cloudLoadItems();
  }catch{ ONLINE=false; $('#modeBadge').textContent='本地模式'; $('#btnLogin').classList.remove('hidden'); $('#btnLogout').classList.add('hidden'); items = load(); render(); }
}
async function cloudLoadItems(){ if(!ONLINE) return;
  const cloud = await api('/api/items'); const local = load(); const map = new Map();
  cloud.forEach(it=>map.set(it.id,it)); local.forEach(it=>{if(!map.has(it.id)) map.set(it.id,it)}); items = Array.from(map.values()); save(); render(); }
async function saveItemToBackend(it){ if(!ONLINE) return; await api('/api/items',{method:'POST',body:JSON.stringify(it)}); }
async function deleteItemFromBackend(id){ if(!ONLINE) return; await api('/api/items?id='+encodeURIComponent(id),{method:'DELETE'}); }

const head=$('#gridHead'),grid=$('#grid'),wrap=$('#gridWrap'),todayLine=$('#todayLine'),leftRows=$('#leftRows'); const COL_W=110;
function startOfMonth(d){const x=new Date(d);x.setDate(1);x.setHours(0,0,0,0);return x}
function addMonths(d,n){const x=new Date(d);x.setMonth(x.getMonth()+n);return x}
function pad2(n){return String(n).padStart(2,'0')}
function resolvePlanPrice(phases,idx){ if(!phases?.length) return null; let a=null; phases.sort((x,y)=>x.fromMonth-y.fromMonth).forEach(p=>{if(idx>=p.fromMonth) a=p.amount}); return a }
function isInCancel(wins,idx){ return wins?.some?.(w=>idx>=w.fromMonth && idx<=w.toMonth) }

function render(){
  const filter = ($('#filter').value||'').trim().toLowerCase();
  const data = filter? items.filter(it=> (it.name+' '+it.type+' '+(it.number||'')).toLowerCase().includes(filter)) : items.slice();
  const months = Number($('#months').value)||72; const today = new Date();
  const minStart = data.length? data.map(it=>startOfMonth(new Date(it.startDate))).reduce((a,b)=>a<b?a:b) : startOfMonth(today);
  const mlist=[]; for(let i=0;i<months;i++) mlist.push(addMonths(minStart,i));
  head.style.gridTemplateColumns = `repeat(${mlist.length}, ${COL_W}px)`;
  head.innerHTML = mlist.map(m=>{ const q=Math.ceil((m.getMonth()+1)/3); return `<div class="cell nowrap" style="height:54px;text-align:center"><div><b>${m.getFullYear()}-${pad2(m.getMonth()+1)}</b></div><div class="small">Q${q}</div></div>` }).join('');
  grid.style.gridTemplateColumns = `repeat(${mlist.length}, ${COL_W}px)`;
  leftRows.innerHTML = data.map(it=>{
    const tag = it.type==='plan'?'套餐':(it.type==='warranty'?'保修':'保险');
    const extra = it.number?`　<span class="small muted">#${it.number}</span>`:'';
    return `<div class="item" draggable="true" data-id="${it.id}"><span class="name" title="按住可拖拽">${it.name}</span><span class="tag">${tag}</span>${extra}<span class="meta">开始:${it.startDate}</span><div class="actions"><button class="btn ghost btn-edit" data-id="${it.id}">编辑</button></div></div>`;
  }).join('');
  $$('#leftRows .item').forEach(el=>{ el.addEventListener('dragstart',ev=>{el.classList.add('dragging');ev.dataTransfer.setData('text/plain',el.dataset.id)}); el.addEventListener('dragend',()=>el.classList.remove('dragging')); });
  leftRows.addEventListener('dragover',e=>{ e.preventDefault(); const dragging=$('.item.dragging',leftRows); const after=Array.from(leftRows.querySelectorAll('.item:not(.dragging)')).find(r=> e.clientY<=r.getBoundingClientRect().top+r.offsetHeight/2); if(after) leftRows.insertBefore(dragging,after); else leftRows.appendChild(dragging); });
  leftRows.addEventListener('drop',()=>{ const order=$$('#leftRows .item').map(x=>x.dataset.id); items.sort((a,b)=> order.indexOf(a.id)-order.indexOf(b.id)); save(); renderGridRows(data,mlist); });
  $$('#leftRows .btn-edit').forEach(btn=> btn.onclick=()=> openEdit(btn.dataset.id));
  renderGridRows(data,mlist);
}
function renderGridRows(data,mlist){
  grid.innerHTML=''; const base=startOfMonth(mlist[0]); const monthsCount=mlist.length; const today=new Date();
  data.forEach(it=>{
    const start=startOfMonth(new Date(it.startDate));
    const diffM=(start.getFullYear()-base.getFullYear())*12+(start.getMonth()-base.getMonth());
    for(let j=0;j<monthsCount;j++){
      const cell=document.createElement('div'); cell.className='cell';
      const idx=j-diffM+1;
      const price=it.type==='plan'? resolvePlanPrice(it.pricePhases||[], idx) : null;
      const isCancel=it.type==='plan'? isInCancel(it.cancelWindows||[], idx) : false;
      if(it.type!=='plan' && idx>=1 && idx <= (it.warrantyMonths||0)){
        const div=document.createElement('div'); div.className='chip'; div.innerHTML='<div>'+ (it.type==='warranty'?'保修中':'保险中') +'</div>'; cell.appendChild(div);
      }else if(price!=null && idx>=1){
        const div=document.createElement('div'); div.className='chip'; div.innerHTML=`<div>¥ ${price.toLocaleString()}</div>` + (isCancel?`<div class="sub">退会期</div>`:''); cell.appendChild(div);
      }
      grid.appendChild(cell);
    }
  });
  const t0=startOfMonth(mlist[0]); const t1=startOfMonth(mlist[mlist.length-1]);
  if(today>=t0 && today<=new Date(t1.getFullYear(),t1.getMonth()+1,1)){ todayLine.style.display='block'; const monthsFromStart=(today.getFullYear()-t0.getFullYear())*12+(today.getMonth()-t0.getMonth()); todayLine.style.left=`calc(${monthsFromStart} * var(--cell-w) + var(--cell-w) / 2 - 1px)`; } else todayLine.style.display='none';
}

function syncTypeUI(){ const type=$('#f_type').value; $('#planBlock').style.display= type==='plan'? '':'none'; $('#row_billday').style.display= type==='plan'? '':'none'; $('#row_wm').style.display= type!=='plan'? '':'none'; }
$('#f_type').addEventListener('change', syncTypeUI);

function addPhase(init){ const div=document.createElement('div'); div.className='phase'; div.innerHTML=`<div class="row" style="gap:8px;align-items:center;margin-top:6px"><span class="small">第</span><input class="m" type="number" min="1" value="${init?.fromMonth||1}" style="width:80px"><span class="small">个月起</span><input class="a" type="number" value="${init?.amount||0}" style="width:120px"><span class="small">日元/月</span><button class="btn ghost del" type="button">删除</button></div>`; div.querySelector('.del').onclick=()=>div.remove(); $('#phaseList').appendChild(div); }
function addCancel(init){ const div=document.createElement('div'); div.className='cancel'; div.innerHTML=`<div class="row" style="gap:8px;align-items:center;margin-top:6px"><span class="small">第</span><input class="fm" type="number" min="1" value="${init?.fromMonth||1}" style="width:80px"><span class="small">-</span><input class="tm" type="number" min="1" value="${init?.toMonth||1}" style="width:80px"><span class="small">个月</span><button class="btn ghost del" type="button">删除</button></div>`; div.querySelector('.del').onclick=()=>div.remove(); $('#cancelList').appendChild(div); }
$('#btnAddPhase').onclick=()=>addPhase(); $('#btnAddCancel').onclick=()=>addCancel();

function readForm(){
  const type=$('#f_type').value.trim(); const name=$('#f_name').value.trim(); const start=$('#f_start').value;
  if(!name) return alert('请填写项目名称'); if(!start) return alert('请选择开始日期');
  const base={ type, name, number:$('#f_number').value.trim(), startDate:start, notes:$('#f_notes').value.trim() };
  if(type==='warranty' || type==='insurance') return { id:editingId||`it_${Date.now()}`, ...base, warrantyMonths:Number($('#f_wm').value)||0 };
  const phases=[...$$('#phaseList .phase')].map(row=>({fromMonth:Number(row.querySelector('.m').value)||1, amount:Number(row.querySelector('.a').value)||0})).sort((a,b)=>a.fromMonth-b.fromMonth);
  const cancels=[...$$('#cancelList .cancel')].map(row=>({fromMonth:Number(row.querySelector('.fm').value)||1, toMonth:Number(row.querySelector('.tm').value)||1}));
  return { id:editingId||`it_${Date.now()}`, ...base, billingDay:Number($('#f_bill').value)||1, pricePhases:phases, cancelWindows:cancels };
}

const dlg=$('#dlgEdit');
function openEdit(id){
  const it=items.find(x=>x.id===id); editingId=it?.id||null; $('#dlgTitle').textContent= it?'编辑项目':'新增项目';
  $('#btnDelete').style.display= it?'':'none';
  $('#f_type').value=it?.type||'plan'; $('#f_name').value=it?.name||''; $('#f_number').value=it?.number||''; $('#f_start').value=it?.startDate||''; $('#f_notes').value=it?.notes||''; $('#f_bill').value=it?.billingDay||1; $('#f_wm').value=it?.warrantyMonths||24; syncTypeUI();
  $('#phaseList').innerHTML=''; (it?.pricePhases||[{fromMonth:1,amount:0}]).forEach(addPhase);
  $('#cancelList').innerHTML=''; (it?.cancelWindows||[]).forEach(addCancel);
  dlg.showModal();
}
$('#btnAdd').onclick=()=>openEdit(null); $('#btnClose').onclick=()=>dlg.close();
$('#btnDelete').onclick=async ()=>{ if(!editingId) return; if(!confirm('确定删除该项目？')) return; const idx=items.findIndex(x=>x.id===editingId); if(idx>=0){ const del=items.splice(idx,1)[0]; save(); render(); await deleteItemFromBackend(del.id);} dlg.close(); };
$('#btnSave').onclick=async ()=>{ const it=readForm(); if(!it) return; const idx=items.findIndex(x=>x.id===it.id); if(idx>=0) items[idx]=it; else items.push(it); save(); render(); dlg.close(); await saveItemToBackend(it); };

const dlgAuth=$('#dlgAuth');
$('#btnLogin').onclick=()=>{ $('#authMsg').textContent=''; dlgAuth.showModal(); };
$('#authCancel').onclick=()=>dlgAuth.close();
async function doRegister(){ try{ $('#authRegister').disabled=true; $('#authLogin').disabled=true; $('#authMsg').style.color='#10b981'; $('#authMsg').textContent=''; const email=$('#authEmail').value.trim(), password=$('#authPass').value; await api('/api/register',{method:'POST',body:JSON.stringify({email,password})}); $('#authMsg').style.color='#10b981'; $('#authMsg').textContent='注册成功，请点击登录'; }catch(e){ $('#authMsg').style.color='#ef4444'; $('#authMsg').textContent=e.message||'注册失败'; }finally{ $('#authRegister').disabled=false; $('#authLogin').disabled=false; } }
async function doLogin(){ try{ $('#authRegister').disabled=true; $('#authLogin').disabled=true; const email=$('#authEmail').value.trim(), password=$('#authPass').value; await api('/api/login',{method:'POST',body:JSON.stringify({email,password})}); dlgAuth.close(); await checkLogin(); }catch(e){ $('#authMsg').style.color='#ef4444'; $('#authMsg').textContent=e.message||'登录失败'; }finally{ $('#authRegister').disabled=false; $('#authLogin').disabled=false; } }
$('#authRegister').onclick=doRegister; $('#authLogin').onclick=doLogin;
$('#btnLogout').onclick=async ()=>{ try{ await api('/api/logout',{method:'POST'}) }catch{} await checkLogin(); };

$('#filter').addEventListener('input', render); $('#months').addEventListener('change', render);
$('#jumpToday').onclick=()=>{ const today=new Date(); const headerCells=$$('#gridHead .cell'); if(!headerCells.length) return; const startText=headerCells[0].innerText.slice(0,7); const [y0,m0]=startText.split('-').map(Number); const idx=(today.getFullYear()-y0)*12 + (today.getMonth()+1 - m0); wrap.scrollTo({left: Math.max(0, idx*110 - wrap.clientWidth/2), behavior:'smooth'}); };

items = load(); render(); checkLogin();
</script>
</body>
</html>
