<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>费用时间轴</title>
<style>
:root{--brand:#3b82f6;--muted:#667085;--card:#ffffff;--line:#eef0f3;--pill:#f1f5ff;--row-h:72px;--col-w:110px;--radius:14px}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#f6f8fb;color:#0f172a;font:15px/1.6 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
button{border:0;border-radius:10px;background:#111827;color:#fff;padding:8px 12px;cursor:pointer}
button.ghost{background:#eceff3;color:#111827} button.primary{background:var(--brand)}
input,select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff;outline:none}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.wrap{max-width:1200px;margin:18px auto;padding:0 12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:10px}

.header{ display: flex; flex-direction: column; gap: 10px; }
.header .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.auth-group { display: flex; gap: 8px; align-items: center; }
#btnUser { max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

#layout{display:grid;grid-template-columns: 340px 1fr; gap:14px; align-items:start}
@media (min-width: 861px){
  #leftWrap{
    max-height: calc(var(--row-h) * 4 + 24px);
    overflow-y: auto;
    padding-top: 4px;
    padding-left: 4px;
    padding-right: 6px; 
  }
}

.item{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-radius:12px;border:1px solid var(--line);background:#fff;height:var(--row-h);gap:8px;margin-bottom:8px;cursor:grab}
.item:active { cursor: grabbing; }
.item.active{outline:2px solid var(--brand)} 

.item > div:first-child {
  min-width: 0;
}

.item-line-1 { display: flex; align-items: baseline; gap: 8px; font-weight: 600; }
.item-line-1 > span:first-child { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }

.item-line-1 .item-number { 
  margin-left: auto; 
  flex-shrink: 1;
  font-size: 12px; 
  color: var(--muted); 

  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 120px;
}

.item-line-2 { font-size: 12px; color: var(--muted); margin-top: 2px; }
.item-line-3 { font-size: 12px; margin-top: 2px; }

#gridHead{display:grid;gap:8px;margin-bottom:8px} #grid{display:grid;gap:8px}
.cell{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px; position: relative;}
.nowrap{white-space:nowrap}
.badge{display:inline-block;padding:6px 10px;border-radius:10px;background:#eef5ff;color:#0f172a;border:1px solid #dbe8ff}
.badge.cancel{background:#fff6f1;border-color:#ffd8bf}
.badge.amount-segment-1 { background:#eef5ff; border-color:#dbe8ff; } 
.badge.amount-segment-2 { background:#fffbe6; border-color:#ffe58f; } 

.cell.today-month {
  background-color: #eef5ff;
  border-color: #dbe8ff;
}

#dlg{position:fixed; inset:0; display:none; align-items:center; justify-content:center;background:rgba(0,0,0,.35); z-index:9999}
#panel{width:min(680px,92vw); max-height:92vh; overflow:auto;background:#fff;border-radius:14px;padding:14px; box-shadow:0 12px 32px rgba(0,0,0,.18)}
fieldset{border:1px dashed var(--line);border-radius:10px;padding:8px;margin-top:6px}
fieldset legend{font-size:12px;color:var(--muted)} .row-fields{display:flex;gap:8px;align-items:center;margin:6px 0}

.row-fields input{width:100px} 
.row-fields .m{width:60px}   
.row-fields .a{width:80px}   
.row-fields .fm{width:60px}  
.row-fields .tm{width:60px}  

.icon-btn {
    display: flex; justify-content: center; align-items: center;
    width: 34px; height: 34px; border: none; border-radius: 50%; 
    font-size: 1.2rem; font-weight: bold; line-height: 1;
    cursor: pointer; flex-shrink: 0; transition: background-color 0.2s;
}
.delete-btn { background-color: #fff0f0; color: #d93025; border: 1px solid #f5c6cb; }
.delete-btn:hover { background-color: #f8d7da; }
.add-btn { background-color: #e6f7ff; color: #1890ff; border: 1px solid #b0dfff; }
.add-btn:hover { background-color: #d9efff; }

@media (max-width: 860px){
  #layout{grid-template-columns: 1fr}
  .row-fields{flex-wrap:wrap}
  #phaseList .row-fields,
  #cancelList .row-fields { flex-wrap: nowrap; }
  #leftWrap { max-height: 22vh; overflow-y: auto; padding-top: 4px; padding-left: 4px; padding-right: 6px; }
}

#dlgAuth .auth-view { display: none; }
#dlgAuth .auth-view.active { display: block; }
.link-btn {
  background: none; border: none; color: var(--brand);
  cursor: pointer; padding: 0; font-size: 12px; text-align: left;
}

/* --- 【新增】Loader 样式 --- */
.loader-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.6);z-index:10000}
.loader-spin{width:40px;height:40px;border:4px solid var(--line);border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div id="loader" class="loader-wrap" style="display:none"><div class="loader-spin"></div></div>

<div class="wrap">
  <div class="header card">
    <div class="row" style="justify-content: space-between;">
      <b>费用时间轴</b>
      <div class="auth-group">
        <button id="btnUser" class="ghost">登录/注册</button>
        <button id="btnLogout" class="ghost" style="display:none">登出</button>
      </div>
    </div>
    <div class="row">
      <input id="filter" placeholder="搜索项目/类型/编号..." style="flex: 1; min-width: 0;"/>
      <button id="btnSearch" class="ghost">搜索</button>
      <button id="btnClearSearch" class="ghost">清空</button>
      <button id="btnToday" class="ghost">本月</button>
    </div>
    <div class="row">
      <button id="btnAdd"  class="primary" style="width: 100%;">添加项目</button>
    </div>
  </div>

  <div id="layout">
    <div class="card">
      <div id="leftWrap"></div>
    </div>

    <div id="gridContainer" class="card" style="overflow-x: auto;">
      <div id="gridHead"></div>
      <div id="grid"></div>
    </div>
  </div>
</div>

<div id="dlg">
  <div id="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="dlgTitle">编辑项目</h3><button id="btnClose" class="ghost">×</button>
    </div>
    
    <div class="row" style="gap:10px">
      <select id="f_type" style="width: 100px;">
        <option value="plan">套餐</option>
        <option value="warranty">保修</option>
        <option value="insurance">保险</option>
      </select>
      <input id="f_name" placeholder="项目名称" style="flex: 1; min-width: 0;"/>
    </div>
    <div class="row" style="gap:10px; margin-top: 8px;">
      <input id="f_number" placeholder="编号/卡号(可选)" style="width: 100%;"/>
    </div>
    <div class="row" style="gap:10px; margin-top: 8px; align-items: center;">
      <label class="small" for="f_start">开始日</label>
      <input id="f_start" type="date" style="width: 130px;"/>
    </div>
    <div id="blockPlan">
      <div class="row" style="margin-top:6px"><label class="small">出账日</label><input id="f_bill" type="number" min="1" max="28" value="1" style="width:80px"/></div>
      
      <fieldset>
        <legend>金额（从第 X 个月起，￥金额 / 月）</legend>
        <div id="phaseList"></div>
        <div style="margin-top:6px">
          <button id="btnAddPhase" class="icon-btn add-btn" type="button">➕</button>
        </div>
      </fieldset>
      
      <fieldset>
        <legend>退会（从第 X ～ 第 Y 个月为退会期）</legend>
        <div id="cancelList"></div>
        <div style="margin-top:6px">
          <button id="btnAddCancel" class="icon-btn add-btn" type="button">➕</button>
        </div>
      </fieldset>
      
      <div id="subBlockInsurance" style="display:none; margin-top:8px;">
        <label class="small">保期</label>
        <input id="f_ins_y" type="number" min="0" placeholder="年" style="width:80px">
        <input id="f_ins_m" type="number" min="0" max="11" placeholder="月" style="width:80px">
      </div>
      
    </div>
    <div id="blockWarranty" style="display:none;margin-top:8px"><label class="small">保修期（月）</label><input id="f_wm" type="number" min="0" value="24" style="width:120px"/></div>
    
    <div id="dlg_msg" class="small" style="color:#ef4444; margin-top: 10px; text-align: right;"></div>
    
    <div style="display:flex;gap:8px;justify-content:space-between;margin-top:12px">
      <button id="btnDeleteInDialog" class="ghost" type="button" style="color: #d93025; background: #fff0f0; border-color: #f5c6cb; display: none;">删除</button>
      <div>
        <button id="btnCancel" class="ghost" type="button">取消</button>
        <button id="btnSave" class="primary" type="button">保存</button>
      </div>
    </div>
  </div>
</div>

<div id="dlgAuth" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);align-items:center;justify-content:center;z-index:9999">
  <div class="card" style="width:min(520px,92vw);padding:14px">
    
    <div id="viewLogin" class="auth-view active">
      <h3>登录</h3>
      <div style="display:flex;flex-direction:column;gap:10px">
        <input id="login_em" placeholder="邮箱"/>
        <input id="login_pw" type="password" placeholder="密码"/>
        <div id="login_msg" class="small" style="color:#ef4444"></div>
        <div class="row" style="justify-content: space-between;">
          <button class="link-btn" id="btnGoReset" type="button">忘记密码？</button>
          <div>
            <button id="btnAuthCancel" class="ghost" type="button">取消</button>
            <button id="btnGoReg" class="ghost" type="button">注册</button>
            <button id="goLogin" class="primary" type="button">登录</button>
          </div>
        </div>
      </div>
    </div>

    <div id="viewRegister" class="auth-view">
      <h3>注册</h3>
      <div style="display:flex;flex-direction:column;gap:10px">
        <input id="reg_em" placeholder="邮箱"/>
        <input id="reg_pw" type="password" placeholder="密码（≥10位）"/>
        <div class="row" style="gap: 8px;">
          <input id="reg_code" placeholder="6位验证码" style="flex: 1; min-width: 0;"/>
          <button id="btnSendRegCode" class="ghost" type="button">发送验证码</button>
        </div>
        <div id="reg_msg" class="small" style="color:#ef4444"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btnRegCancel" class="ghost" type="button">取消</button>
          <button id="btnGoLogin" class="ghost" type="button">返回登录</button>
          <button id="goReg" class="primary" type="button">确认注册</button>
        </div>
      </div>
    </div>
    
    <div id="viewReset" class="auth-view">
      <h3>重置密码</h3>
      <div style="display:flex;flex-direction:column;gap:10px">
        <input id="reset_em" placeholder="注册邮箱"/>
        <div class="row" style="gap: 8px;">
          <input id="reset_code" placeholder="6位验证码" style="flex: 1; min-width: 0;"/>
          <button id="btnSendResetCode" class="ghost" type="button">发送验证码</button>
        </div>
        <input id="reset_pw" type="password" placeholder="新密码（≥10位）"/>
        <div id="reset_msg" class="small" style="color:#ef4444"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btnResetCancel" class="ghost" type="button">取消</button>
          <button id="btnGoLoginReset" class="ghost" type="button">返回登录</button>
          <button id="goReset" class="primary" type="button">确认重置</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const COL_W=110; 
let allCloudItems = [];
let items = []; 
let activeId=null, editingId=null, ONLINE=false;
let sortableList = null;

// --- 【新增】Loader 引用和辅助函数 ---
const $loader = $('#loader');
function showLoader() { $loader.style.display = 'flex'; }
function hideLoader() { $loader.style.display = 'none'; }

// --- 【新增】主弹窗错误提示 ---
const $dlgMsg = $('#dlg_msg');
function showDialogMsg(message, isError = true) {
  $dlgMsg.textContent = message;
  $dlgMsg.style.color = isError ? '#ef4444' : '#16a34a';
}

function pad2(n){return (n<10?'0':'')+n;} 
// --- 【修改】统一的日期解析函数，避免时区问题 ---
function parseISODate(s) { // s = 'YYYY-MM-DD'
  if (!s) return new Date(); // Fallback
  const parts = s.split('-').map(Number);
  // 使用 年, 月-1, 日 构造函数，强制使用本地时区解析
  return new Date(parts[0], parts[1] - 1, parts[2]); 
}
function startOfMonth(d){return new Date(d.getFullYear(), d.getMonth(), 1)} 
function addMonths(d,n){ return new Date(d.getFullYear(), d.getMonth()+n, 1) }
function MaxDate(d1, d2) { return d1 > d2 ? d1 : d2; }

function syncTypeUI(){ 
  const t=$('#f_type').value; 
  $('#blockPlan').style.display=(t==='plan'||t==='insurance')?'block':'none'; 
  $('#blockWarranty').style.display=(t==='warranty')?'block':'none'; 
  $('#subBlockInsurance').style.display=(t==='insurance')?'block':'none';
}

function addPhase(i){const d=document.createElement('div');d.className='row-fields';d.innerHTML=`<span class=small>第</span><input class=m type="number" min=1 value="${i?.fromMonth||1}"><span class=small>个月起</span><input class=a type="number" value="${i?.amount||0}"><span class=small>日元/月</span><button class="icon-btn delete-btn del" type="button">➖</button>`;d.querySelector('.del').onclick=()=>d.remove();$('#phaseList').appendChild(d)}
function addCancel(i){const d=document.createElement('div');d.className='row-fields';d.innerHTML=`<span class=small>第</span><input class=fm type="number" min=1 value="${i?.fromMonth||1}"><span class=small>-</span><input class=tm type="number" min=1 value="${i?.toMonth||1}"><span class=small>个月</span><button class="icon-btn delete-btn del" type="button">➖</button>`;d.querySelector('.del').onclick=()=>d.remove();$('#cancelList').appendChild(d)}
$('#btnAddPhase').onclick=()=>addPhase(); $('#btnAddCancel').onclick=()=>addCancel();

function readForm(){ 
  showDialogMsg('', false); // 清空错误
  const type=$('#f_type').value.trim(), name=$('#f_name').value.trim(), start=$('#f_start').value; 
  if(!name){ showDialogMsg('请填写项目名称');return null} 
  if(!start){ showDialogMsg('请选择开始日期');return null} 
  const base={type,name,number:$('#f_number').value.trim(),startDate:start}; 
  if(type==='warranty'){
    return { id:editingId||undefined, ...base, warrantyMonths:Number($('#f_wm').value)||0 }
  } 
  const phases=[...$$('#phaseList .row-fields')].map(r=>({fromMonth:Number(r.querySelector('.m').value)||1,amount:Number(r.querySelector('input.a').value)||0})).sort((a,b)=>a.fromMonth-b.fromMonth); 
  const cancels=[...$$('#cancelList .row-fields')].map(r=>({fromMonth:Number(r.querySelector('.fm').value)||1,toMonth:Number(r.querySelector('.tm').value)||1})); 
  return {
    id:editingId||undefined, ...base,
    billingDay:Number($('#f_bill').value)||1,
    pricePhases:phases, cancelWindows:cancels,
    policyTermYears: Number($('#f_ins_y').value) || 0,
    policyTermMonths: Number($('#f_ins_m').value) || 0
  }; 
}

function fillForm(it){ 
  $('#f_type').value=it?.type||'plan'; 
  $('#f_name').value=it?.name||''; 
  $('#f_number').value=it?.number||''; 
  $('#f_start').value=it?.startDate||''; 
  $('#f_bill').value=it?.billingDay||1; 
  $('#f_wm').value=it?.warrantyMonths||24; 
  $('#phaseList').innerHTML=''; 
  $('#cancelList').innerHTML=''; 
  (it?.pricePhases?.length?it.pricePhases:[{fromMonth:1,amount:0}]).forEach(addPhase); 
  (it?.cancelWindows||[]).forEach(addCancel); 
  $('#f_ins_y').value = it?.policyTermYears || ''; 
  $('#f_ins_m').value = it?.policyTermMonths || ''; 
  syncTypeUI(); 
}

function resolvePlanPrice(ph,idx){ if(!ph?.length) return null; let a=null; ph.sort((x,y)=>x.fromMonth-y.fromMonth).forEach(p=>{ if(idx>=p.fromMonth) a=p.amount }); return a } 
function isInCancel(w,idx){ return w?.some?.(x=> idx>=x.fromMonth && idx<=x.toMonth) }
function visibleItems(){ return activeId? items.filter(i=>i.id===activeId) : (items.length?[items[0]]:[]) }

function scrollToToday(behavior = 'smooth') {
  const today = new Date();
  const ym = `${today.getFullYear()}-${pad2(today.getMonth() + 1)}`;
  const gridContainer = $('#gridContainer');
  const todayCellHead = $(`#gridHead [data-ym="${ym}"]`);
  
  if (todayCellHead) {
    // 滚动到最左侧, 留 10px 边距
    const targetScroll = todayCellHead.offsetLeft - gridContainer.offsetLeft - 10;
    gridContainer.scrollTo({ left: Math.max(0, targetScroll), behavior: behavior });
  } else {
    // console.warn('Today is not in the rendered range.');
  }
}

function render(){ 
  // --- 1. 执行过滤 ---
  const term = $('#filter').value.trim().toLowerCase();
  if (!term) {
    items = [...allCloudItems]; 
  } else {
    items = allCloudItems.filter(it => { 
      return (it.name && it.name.toLowerCase().includes(term)) ||
             (it.type && it.type.toLowerCase().includes(term)) ||
             (it.number && it.number.toLowerCase().includes(term));
    });
  }
  if (!items.find(it => it.id === activeId)) {
    activeId = items[0]?.id || null;
  }
  
  // --- 2. 渲染左侧列表 ---
  const L=$('#leftWrap');
  if(sortableList) {
    sortableList.destroy();
    sortableList = null;
  }
  
  L.innerHTML = items.map(it => { 
    const typeLabel = it.type === 'plan' ? '<span class="small" style="color:#6b5cff">套餐</span>' :
                    it.type === 'insurance' ? '<span class="small" style="color:#10b981">保险</span>' :
                    '<span class="small" style="color:#3b82f6">保修</span>';
    
    let subDetail = '';
    if (it.type === 'warranty') {
      if (it.warrantyMonths) subDetail = `<span class="small" style="color:#3b82f6">保修期 ${it.warrantyMonths} 个月</span>`;
    } else if (it.type === 'plan') {
      if (it.cancelWindows && it.cancelWindows.length > 0) subDetail = `<span class="small" style="color:#6b5cff">退会期 第 ${it.cancelWindows[0].fromMonth} 个月</span>`;
    } else if (it.type === 'insurance') {
      const y = it.policyTermYears || 0;
      const m = it.policyTermMonths || 0;
      let termStr = '';
      if (y > 0) termStr += `${y}年`;
      if (m > 0) termStr += `${m}个月`;
      if (termStr) subDetail = `<span class="small" style="color:#10b981">保期 ${termStr}</span>`;
    }

    return `<div class="item ${it.id===activeId?'active':''}" data-id="${it.id}">
      <div>
        <div class="title item-line-1">
          <span>${it.name}</span>
          ${typeLabel}
          <span class="meta item-number">#${it.number||'-'}</span>
        </div>
        <div class="meta item-line-2">
          <span>开始: ${it.startDate||'-'}</span>
        </div>
        <div class="meta item-line-3">
          ${subDetail} </div>
      </div>
      <div class="ops">
        <button class="ghost btnEdit" data-id="${it.id}" type="button">编辑</button>
      </div>
    </div>`;
  }).join(''); 
  
  L.querySelectorAll('.item').forEach(div=>{ const id=div.dataset.id; div.onclick=e=>{ if(e.target.closest('button')) return; activeId=id; render(); }; }); 
  
  L.querySelectorAll('.btnEdit').forEach(b=> b.onclick=e=>{
    e.stopPropagation(); 
    const it=allCloudItems.find(x=>x.id===b.dataset.id); 
    editingId=it.id; 
    fillForm(it); 
    showDialogMsg('', false); // 【修改】清空错误
    $('#dlgTitle').textContent='编辑项目'; 
    $('#btnDeleteInDialog').style.display = 'inline-block';
    $('#dlg').style.display='flex';
  }); 
  
  // --- 3. 渲染右侧时间轴 ---
  const data=visibleItems(); const head=$('#gridHead'),grid=$('#grid'); 
  
  if (!data.length){ 
    head.innerHTML=''; 
    grid.innerHTML='<div class=small>请在左侧选择一个项目，或点击“添加项目”。</div>'; 
    return; 
  } 
  
  const it = data[0]; 
  
  // --- 【修改】使用新的日期解析函数 ---
  const minStart = startOfMonth(parseISODate(it.startDate || null));
  const today = new Date();
  const todayPlusOneYear = addMonths(today, 12);
  let maxEndCandidate = MaxDate(todayPlusOneYear, minStart);
  const itemStartDate = parseISODate(it.startDate);
  
  if (it.type === 'plan' || it.type === 'insurance') {
    if (it.pricePhases && it.pricePhases.length > 0) {
      const lastPhase = it.pricePhases.sort((a,b) => b.fromMonth - a.fromMonth)[0];
      const lastPhaseMonth = (lastPhase.fromMonth || 1) - 1;
      const lastPhaseDate = addMonths(itemStartDate, lastPhaseMonth);
      maxEndCandidate = MaxDate(maxEndCandidate, addMonths(lastPhaseDate, 12));
    }
    if (it.cancelWindows && it.cancelWindows.length > 0) {
      const lastWindow = it.cancelWindows.sort((a,b) => b.toMonth - a.toMonth)[0];
      const lastWindowMonth = (lastWindow.toMonth || 1) - 1; 
      const lastWindowDate = addMonths(itemStartDate, lastWindowMonth);
      maxEndCandidate = MaxDate(maxEndCandidate, addMonths(lastWindowDate, 12));
    }
    if (it.type === 'insurance') {
      const policyMonths = (Number(it.policyTermYears) || 0) * 12 + (Number(it.policyTermMonths) || 0);
      if (policyMonths > 0) {
        const policyEndDate = addMonths(itemStartDate, policyMonths);
        maxEndCandidate = MaxDate(maxEndCandidate, addMonths(policyEndDate, 12));
      }
    }
  } else if (it.type === 'warranty') {
    const warrantyMonths = Number(it.warrantyMonths) || 0;
    if (warrantyMonths > 0) {
      const warrantyEndDate = addMonths(itemStartDate, warrantyMonths);
      maxEndCandidate = MaxDate(maxEndCandidate, addMonths(warrantyEndDate, 12));
    }
  }
  
  let maxEnd = startOfMonth(maxEndCandidate);
  
  const mlist=[];
  let currentMonth = new Date(minStart);
  while (currentMonth <= maxEnd) {
    mlist.push(new Date(currentMonth));
    currentMonth = addMonths(currentMonth, 1);
  }
  
  head.style.gridTemplateColumns=`repeat(${mlist.length}, ${COL_W}px)`; 
  
  const todayY = today.getFullYear();
  const todayM = today.getMonth();
  const todayD = today.getDate();

  head.innerHTML=mlist.map(m=>{
    const q=Math.ceil((m.getMonth()+1)/3); 
    const ym = `${m.getFullYear()}-${pad2(m.getMonth() + 1)}`;
    const mYear = m.getFullYear();
    const mMonth = m.getMonth();
    const isTodayMonth = mYear === todayY && mMonth === todayM;
    const daysInMonth = new Date(mYear, mMonth + 1, 0).getDate();
    const totalCols = daysInMonth + 2; 
    const gridStyle = `display: grid; grid-template-columns: repeat(${totalCols}, 1fr); align-items: center;`;

    return `<div class="cell nowrap ${isTodayMonth ? 'today-month' : ''}" data-ym="${ym}" style="text-align:center; ${gridStyle}">
      <div style="grid-column: 1 / -1; z-index: 5;">
        <div><b>${m.getFullYear()}-${pad2(m.getMonth()+1)}</b></div>
        <div class=small>Q${q}</div>
      </div>
      ${''}
    </div>`;
  }).join(''); 
  
  grid.style.gridTemplateColumns=`repeat(${mlist.length}, ${COL_W}px)`; 
  // --- 【修改】使用新的日期解析函数 ---
  const m0=startOfMonth(parseISODate(it.startDate)); 
  const MonthIndex=d=>(d.getFullYear()-m0.getFullYear())*12 + d.getMonth()-m0.getMonth() + 1; 
  
  const cells=[]; 
  for(let i=0;i<mlist.length;i++){ 
    const idx=MonthIndex(mlist[i]); 
    const m = mlist[i];
    const mYear = m.getFullYear();
    const mMonth = m.getMonth();
    const isTodayMonth = mYear === todayY && mMonth === todayM;
    const daysInMonth = new Date(mYear, mMonth + 1, 0).getDate();
    const totalCols = daysInMonth + 2; 
    const gridStyle = `display: grid; grid-template-columns: repeat(${totalCols}, 1fr); align-items: center;`;
    const contentDivStart = `<div style="grid-column: 1 / -1; z-index: 5; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px;">`;
    const contentDivEnd = `</div>`;

    if(it.type==='warranty'){ 
      const warrantyMonths = Number(it.warrantyMonths || 0);
      let warrantyBadge = ''; 
      if (idx >= 1 && idx <= warrantyMonths) {
        warrantyBadge = '<span class="badge">保修中</span>';
      } else if (idx > warrantyMonths && warrantyMonths > 0) { 
        warrantyBadge = '<span class="badge cancel">保修外</span>';
      }

      cells.push(`<div class="cell ${isTodayMonth ? 'today-month' : ''}" style="text-align:center; ${gridStyle}">
        ${contentDivStart}
          ${warrantyBadge} 
        ${contentDivEnd}
        ${''}
      </div>`); 
    }else{ 
      const amount=resolvePlanPrice(it.pricePhases,idx); 
      const cancel=isInCancel(it.cancelWindows,idx); 
      let amountBadgeClass = '';
      if (amount != null) {
        const sortedPhases = (it.pricePhases || []).filter(p => p.amount != null).sort((a,b)=>a.fromMonth-b.fromMonth);
        let segmentIndex = 0;
        for (let j = 0; j < sortedPhases.length; j++) {
          if (idx >= sortedPhases[j].fromMonth) {
            segmentIndex = j;
          }
        }
        amountBadgeClass = (segmentIndex % 2 === 0) ? 'amount-segment-1' : 'amount-segment-2';
      }
      
      cells.push(`<div class="cell ${isTodayMonth ? 'today-month' : ''}" style="text-align:center; ${gridStyle}">
        ${contentDivStart}
          ${amount!=null?`<div class="badge ${amountBadgeClass}">￥ ${amount.toLocaleString()}</div>`:''}
          ${cancel?'<div class="badge cancel">退会期</div>':''}
        ${contentDivEnd}
        ${''}
      </div>`); 
    } 
  } 
  grid.innerHTML=cells.join(''); 

  sortableList = new Sortable(L, {
    animation: 150,
    handle: '.item', 
    delay: 500,
    delayOnTouchOnly: true,
    onEnd: async (evt) => { 
      // ... (排序逻辑未修改, 已包含 show/hide loader)
      const movedItem = items[evt.oldIndex]; 
      const masterIndex = allCloudItems.findIndex(it => it.id === movedItem.id);
      const [masterMovedItem] = allCloudItems.splice(masterIndex, 1);
      const newRefId = items[evt.newIndex]?.id;
      const masterNewIndex = newRefId ? allCloudItems.findIndex(it => it.id === newRefId) : allCloudItems.length;
      allCloudItems.splice(masterNewIndex, 0, masterMovedItem);
      const updates = [];
      allCloudItems.forEach((it, idx) => {
        const newOrder = idx + 1; 
        if (it.order !== newOrder) { 
          it.order = newOrder; 
          updates.push(api(`/api/items?id=${it.id}`, {
            method: 'PUT',
            headers: {'content-type': 'application/json'},
            body: JSON.stringify({ order: newOrder }) 
          }));
        }
      });
      showLoader(); // 【修改】
      try {
        if(updates.length > 0) await Promise.all(updates);
      } catch (e) {
        alert('保存排序失败: ' + e.message); // 排序失败用 alert，因为它不依赖弹窗
      } finally {
        await loadCloudItems(); // loadCloudItems 会 hideLoader
      }
    }
  });
  
  setTimeout(() => {
    scrollToToday('auto'); 
  }, 0);
}
$('#f_type').onchange=syncTypeUI; 

$('#btnAdd').onclick=()=>{ 
  editingId=null; 
  fillForm(null); 
  showDialogMsg('', false); // 【修改】清空错误
  $('#dlgTitle').textContent='新增项目'; 
  $('#btnDeleteInDialog').style.display = 'none';
  $('#dlg').style.display='flex'; 
}; 

$('#btnClose').onclick=()=>$('#dlg').style.display='none'; 
$('#btnCancel').onclick=()=>$('#dlg').style.display='none'; 
$('#dlg').addEventListener('click',e=>{ if(e.target.id==='dlg') $('#dlg').style.display='none'; });

// --- 【修改】重写保存逻辑，集成 Loader 和 内部错误提示 ---
$('#btnSave').onclick= async ()=>{ 
  showDialogMsg('', false); // 清空消息
  const it = readForm(); 
  if(!it) return; // readForm 会显示错误
  
  $('#btnSave').disabled = true;
  showLoader();
  try {
    if (editingId) {
      const updatedItem = { ...it, id: editingId }; 
      await api('/api/items?id=' + editingId, {
        method: 'PUT',
        headers: {'content-type': 'application/json'},
        body: JSON.stringify(updatedItem)
      });
    } else {
      await api('/api/items', {
        method: 'POST',
        headers: {'content-type': 'application/json'},
        body: JSON.stringify(it)
      });
    }
    $('#dlg').style.display='none';
    await loadCloudItems(); // loadCloudItems 会 hideLoader
  } catch (e) {
    showDialogMsg(e.message || '保存失败'); // 在弹窗内显示错误
    hideLoader(); // 出错时手动隐藏
  } finally {
    $('#btnSave').disabled = false;
  }
};

// --- 【修改】重写删除逻辑，集成 Loader 和 内部错误提示 ---
$('#btnDeleteInDialog').onclick = async () => {
  if (!editingId) return; 
  if (!confirm('确定要删除该项目吗？此操作无法撤销。')) return;

  const b = $('#btnDeleteInDialog');
  b.disabled = true;
  showDialogMsg('', false);
  showLoader();
  try {
    await api('/api/items?id=' + editingId, { method: 'DELETE' });
    $('#dlg').style.display='none'; // 仅成功时关闭
    await loadCloudItems(); // loadCloudItems 会 hideLoader
  } catch (e) {
    showDialogMsg(e.message || '删除失败'); // 在弹窗内显示错误
    hideLoader(); // 出错时手动隐藏
  } finally {
    b.disabled = false;
  }
};

$('#btnToday').onclick = async () => {
  scrollToToday('smooth');
};

$('#btnSearch').onclick = () => render();
$('#btnClearSearch').onclick = () => {
  $('#filter').value = ''; 
  render(); 
};
$('#filter').onkeyup = e => { if (e.key === 'Enter') render(); };

// 认证 API (未修改, 逻辑OK)
async function api(path, init){
  const r = await fetch(path, { credentials:'include', ...init });
  const text = await r.text();
  let data; try{ data = JSON.parse(text||'{}') }catch{ data = { error:text||'网络错误' } }
  if(!r.ok){
    const isAuthPath = ['/api/login', '/api/register', '/api/register-send-code', '/api/password-reset-send-code', '/api/password-reset-confirm'].includes(path);
    if (r.status === 401 && !isAuthPath) {
      ONLINE = false;
      $('#btnUser').textContent = '登录/注册';
      $('#btnLogout').style.display = 'none';
      DlgAuth.show('login'); 
      hideLoader(); // 【修改】如果401了，隐藏加载动画
    }
    const msg = data.reason ? `${data.error} (${data.reason})` : (data.error || `HTTP ${r.status}`);
    throw new Error(msg);
  }
  return data;
}

// 认证弹窗逻辑 (未修改, 逻辑OK)
const DlgAuth = {
  el: $('#dlgAuth'),
  views: {
    login: $('#viewLogin'),
    register: $('#viewRegister'),
    reset: $('#viewReset'),
  },
  msgs: {
    login: $('#login_msg'),
    register: $('#reg_msg'),
    reset: $('#reset_msg'),
  },
  show(viewName = 'login') { this.switchView(viewName); this.el.style.display = 'flex'; },
  hide() { this.el.style.display = 'none'; },
  switchView(viewName) {
    Object.values(this.views).forEach(v => v.classList.remove('active'));
    Object.values(this.msgs).forEach(m => m.textContent = '');
    if (this.views[viewName]) this.views[viewName].classList.add('active');
  },
  showMsg(view, message, isError = true) {
    if (this.msgs[view]) {
      this.msgs[view].textContent = message;
      this.msgs[view].style.color = isError ? '#ef4444' : '#16a34a';
    }
  },
  startCountdown(btn) {
    let seconds = 60;
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = `重新发送 (${seconds}s)`;
    const interval = setInterval(() => {
      seconds--;
      if (seconds <= 0) {
        clearInterval(interval); btn.textContent = originalText; btn.disabled = false;
      } else {
        btn.textContent = `重新发送 (${seconds}s)`;
      }
    }, 1000);
  }
};

// 认证按钮绑定 (未修改)
$('#btnUser').onclick = () => {
  $('#login_em').value = ''; $('#login_pw').value = '';
  $('#reg_em').value = ''; $('#reg_pw').value = ''; $('#reg_code').value = '';
  $('#reset_em').value = ''; $('#reset_code').value = ''; $('#reset_pw').value = '';
  DlgAuth.show('login'); 
};
$('#btnAuthCancel').onclick = () => DlgAuth.hide();
$('#btnRegCancel').onclick = () => DlgAuth.hide();
$('#btnResetCancel').onclick = () => DlgAuth.hide();
$('#btnGoReg').onclick = () => DlgAuth.switchView('register');
$('#btnGoLogin').onclick = () => DlgAuth.switchView('login');
$('#btnGoLoginReset').onclick = () => DlgAuth.switchView('login');
$('#btnGoReset').onclick = () => DlgAuth.switchView('reset');

// --- 【修改】登出逻辑，添加 Loader ---
$('#btnLogout').onclick = async () => {
  if (!confirm('确定要登出吗？')) return;
  showLoader();
  try { 
    await api('/api/logout', { method: 'POST' }); 
    location.reload(); 
  } 
  catch (e) { 
    alert('登出失败: ' + e.message); // 登出失败用 alert
    hideLoader();
  }
};

// --- 【修改】发送注册码，使用 /api/register-send-code ---
$('#btnSendRegCode').onclick = async () => {
  const btn = $('#btnSendRegCode');
  const email = $('#reg_em').value.trim();
  if (!email) { DlgAuth.showMsg('register', '请输入邮箱'); return; }
  btn.disabled = true; DlgAuth.showMsg('register', '发送中...', false);
  try {
    const data = await api('/api/register-send-code', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ email: email }) });
    DlgAuth.showMsg('register', data.message || '验证码已发送', false);
    DlgAuth.startCountdown(btn); 
  } catch (e) {
    DlgAuth.showMsg('register', e.message || '发送失败');
    btn.disabled = false; 
  }
};

// --- 【修改】注册，使用 /api/register ---
$('#goReg').onclick = async () => {
  const b = $('#goReg'); b.disabled = true; DlgAuth.showMsg('register', '');
  try {
    const email = $('#reg_em').value.trim();
    const password = $('#reg_pw').value;
    const code = $('#reg_code').value.trim();
    await api('/api/register', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ email, password, code }) });
    DlgAuth.showMsg('register', '注册成功，请返回登录', false);
  } catch (e) {
    DlgAuth.showMsg('register', e.message || '注册失败');
  } finally { b.disabled = false; }
};

// --- 【修改】登录逻辑，集成 Loader ---
$('#goLogin').onclick = async () => {
  const b = $('#goLogin'); b.disabled = true; DlgAuth.showMsg('login', '');
  showLoader();
  try {
    await api('/api/login', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ email: $('#login_em').value.trim(), password: $('#login_pw').value }) });
    const me = await api('/api/me');
    ONLINE = true;
    $('#btnUser').textContent = me.email;
    $('#btnLogout').style.display = 'inline-block';
    DlgAuth.hide();
    await loadCloudItems(); // loadCloudItems 会 hideLoader
  } catch (e) {
    DlgAuth.showMsg('login', e.message || '登录失败');
    hideLoader();
  } finally { b.disabled = false; }
};

// 密码重置 (未修改)
$('#btnSendResetCode').onclick = async () => {
  const btn = $('#btnSendResetCode');
  const email = $('#reset_em').value.trim();
  if (!email) { DlgAuth.showMsg('reset', '请输入注册邮箱'); return; }
  btn.disabled = true; DlgAuth.showMsg('reset', '发送中...', false);
  try {
    const data = await api('/api/password-reset-send-code', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ email: email }) });
    DlgAuth.showMsg('reset', data.message || '验证码已发送', false);
    DlgAuth.startCountdown(btn);
  } catch (e) {
    DlgAuth.showMsg('reset', e.message || '发送失败');
    btn.disabled = false;
  }
};

$('#goReset').onclick = async () => {
  const b = $('#goReset'); b.disabled = true; DlgAuth.showMsg('reset', '');
  try {
    const email = $('#reset_em').value.trim();
    const code = $('#reset_code').value.trim();
    const newPassword = $('#reset_pw').value;
    await api('/api/password-reset-confirm', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ email, code, newPassword }) });
    DlgAuth.showMsg('reset', '密码重置成功，请返回登录', false);
  } catch (e) {
    DlgAuth.showMsg('reset', e.message || '重置失败');
  } finally { b.disabled = false; }
};

// --- 【修改】加载数据，集成 Loader ---
async function loadCloudItems() {
  showLoader();
  try {
    allCloudItems = await api('/api/items'); 
    allCloudItems.sort((a, b) => (a.order || 0) - (b.order || 0));
    if (allCloudItems.length > 0 && !allCloudItems.find(it => it.id === activeId)) {
      activeId = allCloudItems[0].id;
    }
    render(); 
  } catch (e) {
    // 错误由 api() 函数处理 (401会弹出登录)
    console.error('加载数据失败: ' + e.message);
  } finally {
    hideLoader();
  }
}

// --- 【修改】检查登录，集成 Loader ---
async function checkLogin() {
  showLoader();
  try {
    const me = await api('/api/me');
    ONLINE = true;
    $('#btnUser').textContent = me.email;
    $('#btnLogout').style.display = 'inline-block';
    await loadCloudItems(); // loadCloudItems 会 hideLoader
  } catch (e) {
    ONLINE = false;
    $('#btnUser').textContent = '登录/注册';
    DlgAuth.show('login'); 
    hideLoader(); // 登录失败时隐藏
  }
}

function bootstrap(){ 
  checkLogin(); 
}
bootstrap();

</script>
</body></html>