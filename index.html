<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>费用 & 保修管理时间轴（单文件 / 无后端 + 可登录云端）</title>
  <style>
    :root{
      --row-h: 80px;
      --brand: #2563eb;
      --muted: #64748b;
      --card: #fff;
      --bg: #f6f7fb;
      --ok: #10b981;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px;}
    h1{font-size:18px;margin:0 0 12px;}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    input,button,select,textarea{font:inherit}
    .btn{border:1px solid #e5e7eb;background:#fff;padding:6px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:#fff;border:1px dashed #cbd5e1}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .small{color:var(--muted);font-size:12px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 1px 0 rgba(0,0,0,.04);padding:12px}
    #layout{display:grid;grid-template-columns:320px 1fr;gap:12px}
    #leftWrap{max-height: calc(var(--row-h) * 3 + 24px); overflow:auto}
    .item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;border:1px solid #eef2f7;background:#fff}
    .item .title{font-weight:600}
    .item .num{font-size:12px;color:var(--muted)}
    .row{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .item.active{outline:2px solid var(--brand);background:#f8fbff}
    #gridHead{display:grid;gap:8px;margin-bottom:10px}
    #grid{display:grid;gap:8px}
    .cell{border-radius:12px;background:#fff;border:1px solid #eef2f7;padding:8px;text-align:center}
    .pill{border-radius:999px;padding:6px 12px;background:#ecfeff;border:1px solid #a5f3fc}
    .fixed-note{margin-top:10px}
    dialog{border:none;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.15);padding:0}
    .dlg{padding:16px 16px 20px 16px;min-width:300px}
    .dlg h3{margin:0 0 8px 0}
    .fld{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    .fld>input,.fld>select,.fld>textarea{padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff}
    .dlg .row{margin-top:8px}
    @media (max-width: 860px){
      #layout{grid-template-columns: 1fr}
      .row-fields{flex-wrap:wrap}
      #leftWrap{max-height:40vh}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>费用 & 保修管理时间轴 <span class="small">（单文件 / 无后端 + 可登录云端）</span></h1>
    <div class="toolbar">
      <input id="filter" placeholder="搜索项目/类型/编号…" style="width:260px;padding:8px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">
      <label class="small">显示月数</label>
      <select id="months" class="btn">
        <option>12</option><option selected>24</option><option>36</option><option>60</option><option>72</option>
      </select>
      <button id="jumpToday" class="btn">跳到今天</button>
      <div style="flex:1"></div>
      <span id="who" class="small tag">本地模式</span>
      <button id="btnLogin" class="btn">登录/注册</button>
      <button id="btnLogout" class="btn" style="display:none">退出</button>
      <button id="btnAdd" class="btn primary">添加项目</button>
    </div>

    <div id="layout">
      <div class="card">
        <div class="small" style="margin-bottom:6px">提示：点击左侧项目切换；时间轴只显示当前选中项目。</div>
        <div id="leftWrap"></div>
      </div>

      <div class="card" style="overflow-x:auto;">
        <div id="gridHead"></div>
        <div id="grid"></div>
        <div class="fixed-note small">提示：横向滚动查看未来月份；鼠标放在金额块可查看具体信息。（退会期显示在金额下方）。</div>
      </div>
    </div>
  </div>

  <dialog id="dlgEdit">
    <form class="dlg" method="dialog">
      <h3>编辑项目</h3>
      <div class="fld"><label>类型</label>
        <select id="f_type">
          <option value="plan">套餐</option>
          <option value="warranty">保修</option>
          <option value="ins">保险</option>
        </select>
      </div>
      <div class="fld"><label>项目名</label><input id="f_name" placeholder="如：乐天卡 / 冰箱"></div>
      <div class="fld"><label>编号（可选）</label><input id="f_number" placeholder="#07012345678"></div>
      <div class="fld"><label>开始日期</label><input id="f_start" type="date"></div>
      <div class="fld" id="rowBill"><label>计费日（每月）</label><input id="f_bill" type="number" min="1" max="28" value="1"></div>
      <div id="planExtra">
        <div class="fld"><label>金额段（元/月）</label>
          <div id="phaseList"></div>
          <button type="button" id="btnAddPhase" class="btn ghost">加金额段</button>
        </div>
        <div class="fld"><label>退会期（月）</label>
          <div id="cancelList"></div>
          <button type="button" id="btnAddCancel" class="btn ghost">加退会期</button>
        </div>
      </div>
      <div class="fld" id="rowWarranty" style="display:none"><label>保修期（月）</label>
        <input id="f_wm" type="number" min="0" value="12">
      </div>
      <div class="fld"><label>备注</label><textarea id="f_notes" rows="3" placeholder="可空"></textarea></div>
      <div class="row">
        <button value="cancel" class="btn">取消</button>
        <div style="flex:1"></div>
        <button id="btnDel" type="button" class="btn">删除</button>
        <button id="btnSave" value="ok" class="btn primary">保存</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlgLogin">
    <form class="dlg" method="dialog">
      <h3>登录 / 注册</h3>
      <div class="fld"><label>邮箱</label><input id="em" placeholder="you@example.com"></div>
      <div class="fld"><label>密码</label><input id="pw" type="password" placeholder="至少 8 位"></div>
      <div id="msg" class="small" style="color:#ef4444"></div>
      <div class="row">
        <button value="cancel" class="btn">取消</button>
        <div style="flex:1"></div>
        <button id="goReg" type="button" class="btn">注册</button>
        <button id="goLogin" value="ok" class="btn primary">登录</button>
      </div>
    </form>
  </dialog>

<script>
const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
let ONLINE=false, activeId=null, editingId=null;
let items = JSON.parse(localStorage.getItem('items_v2')||'[]');

function pad2(n){return String(n).padStart(2,'0')}
function startOfMonth(d){return new Date(d.getFullYear(), d.getMonth(), 1)}
function addMonths(d, add){const t=new Date(d); t.setMonth(t.getMonth()+add); return t}

function save(){localStorage.setItem('items_v2', JSON.stringify(items))}
function load(){return JSON.parse(localStorage.getItem('items_v2')||'[]')}

function visibleItems(){
  if(!activeId && items[0]) activeId = items[0].id;
  return items.filter(x=>x.id===activeId);
}

function renderLeft(){
  const wrap = $('#leftWrap'); wrap.innerHTML='';
  const f = ($('#filter').value||'').trim().toLowerCase();
  const list = items.filter(it=> (it.name + ' ' + (it.type||'') + ' ' + (it.number||'')).toLowerCase().includes(f));
  list.forEach(it=>{
    const d = document.createElement('div'); d.className='item row ' + (it.id===activeId?'active':'');
    d.innerHTML = `<div>
      <div class="title">${it.name||'(未命名)'} ${it.type==='plan'?'<span class="tag">套餐</span>':it.type==='warranty'?'<span class="tag">保修</span>':'<span class="tag">保险</span>'}</div>
      <div class="num small">#${it.number||'-'}　开始: ${it.startDate}</div>
    </div>
    <div>
      <button class="btn ghost btnEdit">编辑</button>
      <button class="btn ghost btnDel">删除</button>
    </div>`;
    d.onclick = (e)=>{ if(e.target.classList.contains('btnEdit')||e.target.classList.contains('btnDel')) return;
      activeId = it.id; render(); };
    d.querySelector('.btnEdit').onclick = (e)=>{e.stopPropagation(); openEdit(it)};
    d.querySelector('.btnDel').onclick = async (e)=>{e.stopPropagation(); if(!confirm('删除这个项目？'))return;
      items = items.filter(x=>x.id!==it.id); save(); render(); if(ONLINE){ await fetch('/api/items?id='+it.id,{method:'DELETE'})}
    };
    wrap.appendChild(d);
  });
}

function resolvePrice(phases, idx){ if(!phases?.length) return null; phases=[...phases].sort((a,b)=>a.fromMonth-b.fromMonth); let a=null; for(const p of phases){ if(idx>=p.fromMonth) a=p.amount } return a }
function isInCancel(wins, idx){ return wins?.some?.(w=> idx>=w.fromMonth && idx<=w.toMonth) }

function renderGrid(){
  const grid = $('#grid'); const head = $('#gridHead');
  const months = Number($('#months').value)||24;
  const data = visibleItems();
  grid.innerHTML=''; head.innerHTML='';
  if(!data.length){ head.style.gridTemplateColumns=''; grid.style.gridTemplateColumns=''; return }
  const minStart = startOfMonth(new Date(data[0].startDate));
  const mlist = []; for(let i=0;i<months;i++) mlist.push(addMonths(minStart,i));
  const COL=140;
  head.style.gridTemplateColumns = `repeat(${mlist.length}, ${COL}px)`;
  head.innerHTML = mlist.map(m=>{
    const q=Math.ceil((m.getMonth()+1)/3);
    return `<div class="cell small"><div><b>${m.getFullYear()}-${pad2(m.getMonth()+1)}</b></div><div>Q${q}</div></div>`;
  }).join('');
  grid.style.gridTemplateColumns = `repeat(${mlist.length}, ${COL}px)`;

  const it = data[0];
  const start = startOfMonth(new Date(it.startDate));
  for(let i=0;i<mlist.length;i++){
    const idx = Math.round((mlist[i]-start)/(1000*3600*24*30));
    if(it.type==='warranty'){
      const wm = Number(it.warrantyMonths||0);
      grid.innerHTML += `<div class="cell"><span class="pill">${i+1<=wm?'保修中':'-'}</span></div>`;
    }else{
      const price = resolvePrice(it.pricePhases, i+1);
      const cancel = isInCancel(it.cancelWindows, i+1);
      grid.innerHTML += `<div class="cell">${price?`<div class="pill">￥${price.toLocaleString()}</div>`:''}${cancel?`<div class="small" style="margin-top:6px;color:#4b5563">退会期</div>`:''}</div>`;
    }
  }
}

function render(){ renderLeft(); renderGrid(); }

function openEdit(init){
  editingId = init?.id || null;
  $('#phaseList').innerHTML=''; $('#cancelList').innerHTML='';
  $('#f_type').value = init?.type || 'plan';
  $('#f_name').value = init?.name || '';
  $('#f_number').value = init?.number || '';
  $('#f_start').value = init?.startDate || '';
  $('#f_bill').value = init?.billingDay || 1;
  $('#f_wm').value = init?.warrantyMonths || 12;
  $('#f_notes').value = init?.notes || '';
  syncTypeUI();
  if(init?.pricePhases) init.pricePhases.forEach(addPhase);
  if(init?.cancelWindows) init.cancelWindows.forEach(addCancel);
  $('#btnDel').style.display = init? 'inline-block':'none';
  $('#dlgEdit').showModal();
}
function syncTypeUI(){
  const type = $('#f_type').value;
  $('#planExtra').style.display = type==='plan' ? '' : 'none';
  $('#rowBill').style.display = type==='plan' ? '' : 'none';
  $('#rowWarranty').style.display = type==='warranty' ? '' : 'none';
}
$('#f_type').addEventListener('change', syncTypeUI);

function addPhase(init){ const div=document.createElement('div'); div.className='row row-fields'; div.innerHTML = `
  <span class="small">第</span><input class="m" type="number" min="1" value="${init?.fromMonth||1}" style="width:80px">
  <span class="small">个月起</span><input class="a" type="number" value="${init?.amount||0}" style="width:120px">
  <span class="small">元/月</span><button class="btn ghost del" type="button">删除</button>`;
  div.querySelector('.del').onclick = ()=>div.remove(); $('#phaseList').appendChild(div);
}
function addCancel(init){ const div=document.createElement('div'); div.className='row row-fields'; div.innerHTML = `
  <span class="small">第</span><input class="fm" type="number" min="1" value="${init?.fromMonth||1}" style="width:80px">
  <span class="small">-</span><input class="tm" type="number" min="1" value="${init?.toMonth||1}" style="width:80px">
  <span class="small">个月</span><button class="btn ghost del" type="button">删除</button>`;
  div.querySelector('.del').onclick = ()=>div.remove(); $('#cancelList').appendChild(div);
}
$('#btnAddPhase').onclick = ()=> addPhase();
$('#btnAddCancel').onclick = ()=> addCancel();

function readForm(){
  const type=$('#f_type').value.trim(); const name=$('#f_name').value.trim(); const start=$('#f_start').value;
  if(!name) return alert('请填写项目名称'); if(!start) return alert('请选择开始日期');
  const base={ type, name, number:$('#f_number').value.trim(), startDate:start, notes:$('#f_notes').value.trim() };
  if(type==='warranty') return { id: editingId||`it_${Date.now()}`, ...base, warrantyMonths:Number($('#f_wm').value)||0 };
  const phases = [...$$('#phaseList .row')].map(row=>({fromMonth:Number(row.querySelector('.m').value)||1, amount:Number(row.querySelector('.a').value)||0})).sort((a,b)=>a.fromMonth-b.fromMonth);
  const cancels = [...$$('#cancelList .row')].map(row=>({fromMonth:Number(row.querySelector('.fm').value)||1, toMonth:Number(row.querySelector('.tm').value)||1}));
  return { id: editingId||`it_${Date.now()}`, ...base, billingDay:Number($('#f_bill').value)||1, pricePhases:phases, cancelWindows:cancels };
}
$('#btnSave').onclick = async ()=>{
  const it=readForm(); if(!it) return;
  const idx = items.findIndex(x=>x.id===it.id);
  if(idx>=0) items[idx]=it; else items.push(it);
  save(); $('#dlgEdit').close(); render();
  if(ONLINE) try{ await saveItemToBackend(it) }catch(e){console.error(e)}
}
$('#btnDel').onclick = async ()=>{
  if(!editingId) return; if(!confirm('确认删除？')) return;
  items = items.filter(x=>x.id!==editingId); save(); $('#dlgEdit').close(); render();
  if(ONLINE) try{ await fetch('/api/items?id='+editingId,{method:'DELETE'}) }catch(e){}
}

async function api(url, opt={}){
  const r = await fetch(url, {credentials:'include', headers:{'content-type':'application/json'}, ...opt});
  const data = await r.json().catch(()=>({}));
  if(!r.ok) throw new Error(data?.error||('HTTP '+r.status));
  return data;
}
async function checkLogin(){
  try{
    const me = await api('/api/me');
    ONLINE=true; $('#who').textContent = me.email || '云端';
    $('#btnLogin').style.display='none'; $('#btnLogout').style.display='inline-block';
    await cloudLoadItems();
  }catch{ ONLINE=false; $('#who').textContent='本地模式'; $('#btnLogin').style.display='inline-block'; $('#btnLogout').style.display='none'; render(); }
}
async function cloudLoadItems(){
  if(!ONLINE) return;
  const cloud = await api('/api/items');
  const locals = load();
  const map = new Map(); cloud.forEach(it=>map.set(it.id,it));
  const localOnly = []; locals.forEach(it=>{ if(!map.has(it.id)){ map.set(it.id,it); localOnly.push(it) } });
  items = Array.from(map.values()); save(); render();
  for(const it of localOnly){ saveItemToBackend(it).catch(()=>{}) }
}
async function saveItemToBackend(it){
  await fetch('/api/items', {method:'POST', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify(it)});
}

$('#btnLogin').onclick = ()=>{ $('#msg').textContent=''; $('#dlgLogin').showModal() }
$('#btnLogout').onclick = async ()=>{ await api('/api/logout',{method:'POST',body:'{}'}); ONLINE=false; $('#who').textContent='本地模式'; $('#btnLogin').style.display='inline-block'; $('#btnLogout').style.display='none' }
$('#goReg').onclick = async ()=>{
  try{
    $('#goReg').disabled=true; $('#goLogin').disabled=true;
    $('#msg').textContent=''; await api('/api/register',{method:'POST', body: JSON.stringify({email:$('#em').value.trim(), password:$('#pw').value})}); $('#msg').textContent='注册成功，请点击登录'
  }catch(e){ $('#msg').textContent=e.message } finally{ $('#goReg').disabled=false; $('#goLogin').disabled=false; }
}
$('#goLogin').onclick = async ()=>{
  try{
    $('#goReg').disabled=true; $('#goLogin').disabled=true;
    $('#msg').textContent=''; await api('/api/login',{method:'POST', body: JSON.stringify({email:$('#em').value.trim(), password:$('#pw').value})}); $('#dlgLogin').close(); await checkLogin();
  }catch(e){ $('#msg').textContent=e.message } finally{ $('#goReg').disabled=false; $('#goLogin').disabled=false; }
}

$('#btnAdd').onclick = ()=> openEdit({type:'plan', name:'', startDate: new Date().toISOString().slice(0,10), billingDay:1, pricePhases:[{fromMonth:1,amount:1000}], cancelWindows:[]});
$('#jumpToday').onclick = ()=>{ document.querySelector('#gridHead')?.scrollIntoView({behavior:'smooth',block:'nearest'}) }
$('#months').onchange = render;
$('#filter').oninput = render;

checkLogin().then(render);
</script>
</body>
</html>
