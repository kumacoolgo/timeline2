<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>费用 & 保修管理时间轴（单文件 / 无后端 + 可登录云端）</title>
<style>
  :root{
    --brand:#2563eb; --bg:#f6f7fb; --card:#fff; --muted:#667085; --text:#111827;
    --chip:#eff6ff; --chip-text:#1d4ed8; --danger:#ef4444; --ok:#059669;
    --col-w:104px;
  }
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
  header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:#fff;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:3}
  .pill{background:#eef2ff;border:1px solid #e5e7eb;color:#4338ca;padding:6px 10px;border-radius:999px;font-size:12px}
  .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:default}
  .ghost{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:7px 10px;cursor:pointer}
  .danger{background:var(--danger) !important}
  input,select,textarea{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;outline:none}
  .row{display:flex;gap:10px;align-items:center}
  .hint{color:var(--muted);font-size:12px}
  .chip{background:var(--chip);color:var(--chip-text);padding:2px 8px;border-radius:999px;font-size:12px}
  .wrap{max-width:1080px;margin:0 auto;padding:16px}
  /* left items list */
  #itemsPanel{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:8px;margin-bottom:12px}
  #itemsList{list-style:none;margin:0;padding:0;max-height:140px;overflow:auto} /* 约两行高度，超出滚动 */
  #itemsList li{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:12px;border:1px solid #eef0f3;margin:6px 4px;background:#fff}
  #itemsList li.active{outline:2px solid var(--brand)}
  .meta{color:var(--muted);font-size:12px}
  .title{font-weight:600}
  .rightBtns{display:flex;gap:8px}
  /* grid */
  #gridWrap{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:8px;overflow:auto}
  #gridHead{display:grid;gap:8px;margin:8px 0 10px 0;position:sticky;top:0;background:#fff;z-index:2}
  #grid{display:grid;gap:8px}
  .cell{height:62px;border:1px dashed #e5e7eb;border-radius:12px;background:#fafafa;position:relative;display:flex;align-items:center;justify-content:center}
  .money{position:absolute;bottom:6px;left:6px;background:#ecfeff;border:1px solid #bae6fd;border-radius:999px;padding:2px 8px;font-size:12px}
  .cancel{position:absolute;top:6px;right:6px;background:#fef3c7;border:1px solid #fde68a;border-radius:999px;padding:2px 8px;font-size:12px}
  .today{position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:2px;height:72px;background:#60a5fa}
  /* dialog */
  dialog{border:0;border-radius:16px;max-width:520px;width:92vw;padding:0;box-shadow:0 10px 30px rgba(0,0,0,.16)}
  .dlg-body{padding:16px}
  .dlg-foot{display:flex;justify-content:flex-end;gap:10px;border-top:1px solid #eef0f3;padding:10px 16px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .full{grid-column:1/-1}
</style>
</head>
<body>
<header class="wrap">
  <div style="font-weight:700">费用 & 保修管理时间轴</div>
  <span class="pill" id="modePill">本地模式</span>
  <input id="filter" placeholder="搜索项目/类型/编号…" style="flex:1;min-width:120px">
  <div class="row">
    <label class="hint">显示月数</label>
    <select id="months">
      <option value="12">12</option><option value="24">24</option><option value="36">36</option>
      <option value="48">48</option><option value="60">60</option><option value="72" selected>72</option>
    </select>
    <button class="ghost" id="btnToday">跳到今天</button>
  </div>
  <button class="ghost" id="btnAuth">登录/注册</button>
  <button class="btn" id="btnAdd">添加项目</button>
</header>

<section class="wrap">
  <div id="itemsPanel">
    <ul id="itemsList"></ul>
    <div class="hint">最多展示两条，其余滚动。点击左侧项目以切换下方时间轴。</div>
  </div>

  <div id="gridWrap">
    <div id="gridHead"></div>
    <div id="grid"></div>
  </div>
</section>

<!-- 登录弹窗 -->
<dialog id="dlgAuth">
  <form method="dialog">
    <div class="dlg-body">
      <h3 style="margin:0 0 8px">登录 / 注册</h3>
      <div class="full"><input id="em" placeholder="邮箱"></div>
      <div class="full" style="margin-top:8px"><input id="pw" type="password" placeholder="密码（≥8位）"></div>
      <div id="msg" class="hint" style="color:var(--danger);margin-top:8px"></div>
    </div>
    <div class="dlg-foot">
      <button class="ghost" value="cancel">取消</button>
      <button class="ghost" id="goReg" type="button">注册</button>
      <button class="btn" id="goLogin" type="button">登录</button>
    </div>
  </form>
</dialog>

<!-- 编辑弹窗 -->
<dialog id="dlgEdit">
  <form method="dialog">
    <div class="dlg-body">
      <h3 id="dlgTitle" style="margin:0 0 8px">项目</h3>
      <div class="grid2">
        <select id="f_type" class="full">
          <option value="plan">套餐 / A+B</option>
          <option value="warranty">保修</option>
          <option value="insure">保险</option>
        </select>
        <input id="f_name" placeholder="项目名，例如：乐天卡" class="full">
        <input id="f_number" placeholder="编号（可选）" class="full">
        <input id="f_start" type="date" class="full">
        <textarea id="f_notes" placeholder="备注（可选）" class="full"></textarea>
      </div>
      <div id="planArea" style="margin-top:8px">
        <div class="row"><b>金额段</b><button class="ghost" id="btnAddPhase" type="button">加金额段</button></div>
        <div id="phaseList"></div>
        <div class="row" style="margin-top:8px"><b>退会期</b><button class="ghost" id="btnAddCancel" type="button">加退会期</button></div>
        <div id="cancelList"></div>
        <div class="row" style="margin-top:8px">
          <label class="hint">每月结算日</label>
          <input id="f_bill" type="number" value="1" style="width:120px">
        </div>
      </div>
      <div id="warrantyArea" style="display:none;margin-top:8px">
        <div class="row"><label>保修月数</label><input id="f_wm" type="number" value="24" style="width:140px"></div>
      </div>
    </div>
    <div class="dlg-foot">
      <button class="ghost" id="btnDelete" type="button" style="margin-right:auto;display:none">删除</button>
      <button class="ghost" value="cancel">取消</button>
      <button class="btn" id="btnSave" type="button">保存</button>
    </div>
  </form>
</dialog>

<script>
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const API = (p,opt={})=>fetch(p,{credentials:'include',headers:{'content-type':'application/json'},...opt}).then(async r=>{if(!r.ok) throw new Error(await r.text()); return r.json()});
let ONLINE=false, ME=null, items=[], selectedId=null;

function save(){ localStorage.setItem('items', JSON.stringify(items)); }
function load(){ try{return JSON.parse(localStorage.getItem('items')||'[]')}catch{return []} }

function renderItems(){
  const li = items.map(it=>{
    const tag = it.type==='warranty'?'保修':(it.type==='insure'?'保险':'套餐');
    const when = (it.startDate||'').slice(0,10);
    return `<li data-id="${it.id}" class="${it.id===selectedId?'active':''}">
      <div>
        <div class="title">${it.name} <span class="chip">${tag}</span></div>
        <div class="meta">#${it.number||'-'}　开始：${when||'-'}</div>
      </div>
      <div class="rightBtns">
        <button class="ghost small btnEdit">编辑</button>
        <button class="ghost small danger btnDel">删除</button>
      </div>
    </li>`
  }).join('');
  $('#itemsList').innerHTML = li || `<div class="hint" style="padding:10px">尚无项目，点击右上角“添加项目”。</div>`;

  // events
  $$('#itemsList li').forEach(li=>{
    li.onclick = (e)=>{
      if(e.target.classList.contains('btnEdit')) return;
      if(e.target.classList.contains('btnDel')) return;
      selectedId = li.getAttribute('data-id');
      renderItems(); renderGrid();
    };
    li.querySelector('.btnEdit').onclick = ()=> openEdit(li.getAttribute('data-id'));
    li.querySelector('.btnDel').onclick = ()=> deleteItem(li.getAttribute('data-id'));
  });
}

function pad2(n){return String(n).padStart(2,'0')}
function startOfMonth(d){d=new Date(d); d.setDate(1); d.setHours(0,0,0,0); return d}
function addMonths(d,n){d=new Date(d); d.setMonth(d.getMonth()+n); return d}

function renderGrid(){
  const mlist=[];
  const months = Number($('#months').value)||72;
  const it = items.find(x=>x.id===selectedId);
  const minStart = it? startOfMonth(new Date(it.startDate)) : startOfMonth(new Date());
  for(let i=0;i<months;i++) mlist.push(addMonths(minStart,i));
  $('#gridHead').style.gridTemplateColumns = `repeat(${mlist.length}, var(--col-w))`;
  $('#grid').style.gridTemplateColumns = `repeat(${mlist.length}, var(--col-w))`;
  $('#gridHead').innerHTML = mlist.map(m=>{
    const q=Math.ceil((m.getMonth()+1)/3);
    return `<div class="cell" style="height:54px"><div style="text-align:center"><b>${m.getFullYear()}-${pad2(m.getMonth()+1)}</b><div class="hint">Q${q}</div></div></div>`
  }).join('');

  if(!it){ $('#grid').innerHTML = ''; return; }
  const blocks = mlist.map((m,idx)=>{
    let money=null, cancel=false;
    if(it.type==='warranty'){
      const wm = Number(it.warrantyMonths||0);
      const begin = 0, end = wm-1;
      if(idx>=begin && idx<=end) cancel = false, money=null; // 仅显示“保修中”标签
    }else{
      const phases=(it.pricePhases||[]).slice().sort((a,b)=>a.fromMonth-b.fromMonth);
      for(const p of phases){ if(idx+1>=p.fromMonth) money=p.amount }
      cancel = (it.cancelWindows||[]).some(w=> idx+1>=w.fromMonth && idx+1<=w.toMonth);
    }
    const parts = [];
    if(money!=null) parts.push(`<div class="money">¥ ${money.toLocaleString()}</div>`);
    if(it.type==='warranty'){
      const wm = Number(it.warrantyMonths||0); if(idx<wm) parts.push(`<div class="money" style="left:auto;right:6px;background:#e0f2fe;border-color:#bae6fd">保修中</div>`);
    }
    if(cancel) parts.push(`<div class="cancel">退会期</div>`);
    return `<div class="cell">${parts.join('')}</div>`;
  }).join('');
  $('#grid').innerHTML = blocks;

  // today line
  const today = new Date(), ts = startOfMonth(today).getTime();
  const pos = mlist.findIndex(m=> m.getTime()===ts);
  if(pos>=0){
    const column = pos+1;
    const tl = document.createElement('div');
    tl.className='today';
    const cell = $('#gridHead').children[column-1]; if(cell){ cell.style.position='relative'; cell.appendChild(tl) }
  }
}

// ======= 编辑弹窗 =======
function openEdit(id){
  syncTypeUI();
  $('#btnDelete').style.display = id ? '' : 'none';
  const it = id? items.find(x=>x.id===id) : {type:'plan',name:'',number:'',startDate:new Date().toISOString().slice(0,10),pricePhases:[{fromMonth:1,amount:0}],cancelWindows:[],billingDay:1,warrantyMonths:24};
  editingId = id || null;
  $('#f_type').value = it.type;
  $('#f_name').value = it.name||'';
  $('#f_number').value = it.number||'';
  $('#f_start').value = (it.startDate||'').slice(0,10);
  $('#f_bill').value = it.billingDay||1;
  $('#f_wm').value = it.warrantyMonths||24;
  $('#f_notes').value = it.notes||'';
  $('#phaseList').innerHTML=''; (it.pricePhases||[]).forEach(addPhase);
  $('#cancelList').innerHTML=''; (it.cancelWindows||[]).forEach(addCancel);
  $('#dlgEdit').showModal();
}
let editingId=null;

function syncTypeUI(){
  const type = $('#f_type').value;
  $('#planArea').style.display = (type==='plan'||type==='insure') ? '' : 'none';
  $('#warrantyArea').style.display = type==='warranty' ? '' : 'none';
}
$('#f_type').onchange = syncTypeUI;
$('#btnAdd').onclick = ()=>{ openEdit(null) };

function addPhase(init){
  const div=document.createElement('div'); div.className='row'; div.innerHTML=`
    <span class="hint">第</span><input class="m" type="number" min="1" value="${init?.fromMonth||1}" style="width:90px">
    <span class="hint">个月起</span><input class="a" type="number" value="${init?.amount||0}" style="width:120px"><span class="hint">元/月</span>
    <button class="ghost del" type="button">删除</button>`;
  div.querySelector('.del').onclick=()=>div.remove();
  $('#phaseList').appendChild(div);
}
function addCancel(init){
  const div=document.createElement('div'); div.className='row'; div.innerHTML=`
    <span class="hint">第</span><input class="fm" type="number" min="1" value="${init?.fromMonth||1}" style="width:90px">
    <span class="hint">-</span><input class="tm" type="number" min="1" value="${init?.toMonth||1}" style="width:90px">
    <span class="hint">个月</span><button class="ghost del" type="button">删除</button>`;
  div.querySelector('.del').onclick=()=>div.remove();
  $('#cancelList').appendChild(div);
}
$('#btnAddPhase').onclick=()=>addPhase();
$('#btnAddCancel').onclick=()=>addCancel();
$('#btnDelete').onclick=async ()=>{
  if(!editingId) return;
  if(!confirm('确定删除?')) return;
  const idx = items.findIndex(x=>x.id===editingId);
  if(idx>=0) items.splice(idx,1);
  save(); renderItems(); renderGrid();
  try{ if(ONLINE) await API('/api/items?id='+editingId, {method:'DELETE'}) }catch(e){ console.warn(e) }
  $('#dlgEdit').close();
}

$('#btnSave').onclick = async ()=>{
  const it = readForm(); if(!it) return;
  const idx = items.findIndex(x=>x.id===it.id);
  if(idx>=0) items[idx]=it; else items.push(it);
  save(); renderItems(); renderGrid();
  try{ if(ONLINE) await API('/api/items', {method:'POST', body:JSON.stringify(it)});}catch(e){console.warn(e)}
  $('#dlgEdit').close();
}
function readForm(){
  const type=$('#f_type').value.trim();
  const name=$('#f_name').value.trim();
  const start=$('#f_start').value;
  if(!name) return alert('请填写项目名称');
  if(!start) return alert('请选择开始日期');
  const base={ type, name, number:$('#f_number').value.trim(), startDate:start, notes:$('#f_notes').value.trim() };
  if(type==='warranty') return { id: editingId||('it_'+Date.now()), ...base, warrantyMonths:Number($('#f_wm').value)||0 };
  const phases=[...$$('#phaseList .row')].map(r=>({fromMonth:Number(r.querySelector('.m').value)||1,amount:Number(r.querySelector('.a').value)||0})).sort((a,b)=>a.fromMonth-b.fromMonth);
  const cancels=[...$$('#cancelList .row')].map(r=>({fromMonth:Number(r.querySelector('.fm').value)||1,toMonth:Number(r.querySelector('.tm').value)||1}));
  return { id: editingId||('it_'+Date.now()), ...base, billingDay:Number($('#f_bill').value)||1, pricePhases:phases, cancelWindows:cancels };
}

// ======= 云端 =======
$('#btnAuth').onclick = ()=> $('#dlgAuth').showModal();
$('#goReg').onclick = async ()=>{
  const btn=$('#goReg'); btn.disabled=true;
  try{
    const r = await API('/api/register',{method:'POST', body:JSON.stringify({email:$('#em').value.trim(), password:$('#pw').value})});
    $('#msg').style.color='#059669'; $('#msg').textContent='注册成功，请点击登录';
  }catch(e){ $('#msg').style.color='var(--danger)'; $('#msg').textContent=e.message.replace(/^Error:\s*/,'') }
  finally{ btn.disabled=false }
};
$('#goLogin').onclick = async ()=>{
  const btn=$('#goLogin'); btn.disabled=true;
  try{
    const r = await API('/api/login',{method:'POST', body:JSON.stringify({email:$('#em').value.trim(), password:$('#pw').value})});
    $('#dlgAuth').close();
    await checkLogin();
  }catch(e){ $('#msg').style.color='var(--danger)'; $('#msg').textContent='邮箱或密码错误'; }
  finally{ btn.disabled=false }
};

async function cloudLoadItems(){
  if(!ONLINE) return;
  try{
    const cloud = await API('/api/items');
    const local = load();
    const map = new Map();
    cloud.forEach(it=>map.set(it.id,it));
    local.forEach(it=>{ if(!map.has(it.id)) map.set(it.id,it) });
    items = Array.from(map.values());
    save();
  }catch(e){ console.warn('load cloud fail',e) }
}

async function checkLogin(){
  try{
    const me = await API('/api/me');
    ONLINE=true; ME=me;
    $('#modePill').textContent='云端'; $('#btnAuth').textContent='退出'; $('#btnAuth').onclick = logout;
    await cloudLoadItems();
  }catch(e){
    ONLINE=false; ME=null;
    $('#modePill').textContent='本地模式'; $('#btnAuth').textContent='登录/注册'; $('#btnAuth').onclick = ()=>$('#dlgAuth').showModal();
  }
  renderItems(); if(!selectedId && items[0]) { selectedId = items[0].id } renderGrid();
}
async function logout(){
  try{ await API('/api/logout'); }catch{}
  ONLINE=false; ME=null; $('#modePill').textContent='本地模式'; $('#btnAuth').textContent='登录/注册'; $('#btnAuth').onclick = ()=>$('#dlgAuth').showModal();
}

async function init(){
  items = load();
  renderItems();
  if(items[0]) selectedId = items[0].id;
  renderGrid();
  await checkLogin();
}
window.addEventListener('load', init);
$('#months').onchange = renderGrid;
$('#btnToday').onclick = ()=>{ document.querySelector('#gridWrap').scrollLeft = 0; };
</script>
</body>
</html>
